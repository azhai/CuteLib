<?php
namespace{defined('VENDOR_ROOT')or define('VENDOR_ROOT',APP_ROOT.'/vendor');defined('APP_CLASS')or define('APP_CLASS','\\Cute\\Website');defined('SQL_VERBOSE')or define('SQL_VERBOSE',true);defined('ERROR_LEVEL')or define('ERROR_LEVEL',E_ALL&~E_DEPRECATED&~E_NOTICE);@error_reporting(ERROR_LEVEL);if(!class_exists('\\Cute\\Importer')){require_once SRC_ROOT.'/Cute/Importer.php';}function app($sD=''){static$j=null;if(is_null($j)&&$sD){$XD=\Cute\Importer::getInstance();$XD->addNamespace('Cute',SRC_ROOT);$tB=\Cute\Base\Storage::newInstance($sD);$H=constant('APP_CLASS');$j=new$H($tB);$j->install($XD,array('import'=>'addNamespace'));$j->initialize();}return$j;}function starts_with($kC,$PC){return strncmp($kC,$PC,strlen($PC))===0;}function ends_with($kC,$PC){$HD=strlen($PC);return$HD===0||(strlen($kC)>=$HD&&substr_compare($kC,$PC,-$HD)===0);}function convert($e,$qB='UTF-8'){$qB=strtoupper($qB);if(function_exists('mb_detect_encoding')){return mb_detect_encoding($e,$qB,true)?$e:mb_convert_encoding($e,$qB,'UTF-8, GBK');}else if(function_exists('iconv')){$AE=$qB==='UTF-8'?'GBK':'UTF-8';return iconv($AE,$qB.'//IGNORE',$e);}}function b64decode($e){if(preg_match('!([A-Za-z0-9+/= ]+)!',$e,$MB)){$e=$MB[1];}return base64_decode($e);}function exec_function_array($o,array$B=array()){switch(count($B)){case 0:return$o();case 1:return$o($B[0]);case 2:return$o($B[0],$B[1]);case 3:return$o($B[0],$B[1],$B[2]);case 4:return$o($B[0],$B[1],$B[2],$B[3]);case 5:return$o($B[0],$B[1],$B[2],$B[3],$B[4]);default:if(is_object($o)){$v=new ReflectionMethod($o,'__invoke');return$v->invokeArgs($o,$B);}else if(is_callable($o)){$v=new ReflectionFunction($o);return$v->invokeArgs($B);}}}function exec_method_array($EB,$V,array$B=array()){if(is_object($EB)){switch(count($B)){case 0:return$EB->{$V}();case 1:return$EB->{$V}($B[0]);case 2:return$EB->{$V}($B[0],$B[1]);case 3:return$EB->{$V}($B[0],$B[1],$B[2]);case 4:return$EB->{$V}($B[0],$B[1],$B[2],$B[3]);case 5:return$EB->{$V}($B[0],$B[1],$B[2],$B[3],$B[4]);}}if(method_exists($EB,$V)){$v=new ReflectionMethod($EB,$V);if($v->isPublic()&&!$v->isAbstract()){if($v->isStatic()){return$v->invokeArgs(null,$B);}else{return$v->invokeArgs($EB,$B);}}}}function exec_construct_array($H,array$B=array()){switch(count($B)){case 0:return new$H();case 1:return new$H($B[0]);case 2:return new$H($B[0],$B[1]);case 3:return new$H($B[0],$B[1],$B[2]);case 4:return new$H($B[0],$B[1],$B[2],$B[3]);case 5:return new$H($B[0],$B[1],$B[2],$B[3],$B[4]);default:if(class_exists($H)){$v=new ReflectionClass($H);return$v->newInstanceArgs($B);}}}}
namespace Cute{use \Cute\Importer;use \Cute\Factory;use \Cute\Base\Storage;abstract class Application{protected$shortcuts=array();function __construct(Storage&$tB){$this->install($tB,array('getConfig'));$zD=new Factory($tB);$this->install($zD,array('load'));}function initialize(){return$this;}function install($GD,array$CE){foreach($CE as$dC=>$V){$dC=strtolower(is_numeric($dC)?$V:$dC);$this->shortcuts[$dC]=array($GD,$V);}return$this;}function __call($A,$B){$A=strtolower($A);if(isset($this->shortcuts[$A])){list($GD,$V)=$this->shortcuts[$A];return exec_method_array($GD,$V,$B);}}abstract function run();}abstract class Command{protected$app=null;protected$args=array();protected$pid=0;var$cmdfile='';function __construct($j,$ND,array$UB=array()){$this->app=$j;$this->cmdfile=$ND;list($B,$DB)=self::parse($UB);$this->args=array_merge($B,$DB);}function __clone(){$this->args=array_change_key_case($this->args);}function __toString(){$B=array();foreach($this->args as$C=>$D){if(is_numeric($C)){$B[]=$D;}else if($D===true){$B[]=strlen($C)===1?" -$C":" --$C";}else{$B[]=" --$C='$D'";}}$jB=$this->cmdfile;$jB.=' '.substr(__CLASS__,0,-strlen('Command'));$jB.=' '.implode(' ',$B);return$jB;}static function parse(array$UB){$B=array();$DB=array();foreach($UB as$WC=>$z){$z=trim($z);if($z==='--'){$B[]=implode(' ',array_slice($UB,$WC+1));break;}if(substr($z,0,1)!=='-'){$B[]=$z;}else if(substr($z,1,1)!=='-'){$UC=str_split(substr($z,1));foreach($UC as$C){$DB[$C]=true;}}else{if(($gD=strpos($z,'='))!==false){$C=substr($z,2,$gD-2);$D=substr($z,$gD+1);}else{$C=substr($z,2);$D=true;}if(!array_key_exists($C,$DB)){$DB[$C]=$D;}else{if(!is_array($DB[$C])){$DB[$C]=array($DB[$C]);}$DB[$C][]=$D;}}}return array($B,$DB);}function addArg($D,$C=false){if($C===false||is_null($C)){$this->args[]=$D;}else{$this->args[$C]=$D;}return$this;}function getArg($C=false,$K=null){if($C===false||is_null($C)){return$this->args;}if(isset($this->args[$C])){return$this->args[$C];}else{return$K;}}function popArg($C){if($C===false||is_null($C)){return;}if(isset($this->args[$C])){$D=$this->args[$C];unset($this->args[$C]);return$D;}}function readPid($uB=null){if(!is_null($uB)&&is_readable($uB)){$eB=trim(file_get_contents($uB));if(is_numeric($eB)){$this->pid=$eB;}}return$this->pid;}function isRunning(){if($this->pid>0){try{$E=shell_exec(sprintf('ps %d',$this->pid));return substr_count($E,"\n")>=2;}catch(\Exception$QB){}}return false;}function wait($KF=0.1){while($this->isRunning()){usleep($KF*1000000);}return true;}function stop(){if($this->pid>0&&$this->isRunning()){return posix_kill($this->pid,SIGTERM);}}function fork($uB=null,array$TC=array()){$rB=clone$this;$rB->args=array_merge($rB->args,$TC);$jB=strval($rB);$j=$rB->app;if($j->outfile!==1){$jB.=' > '.$j->getFileSymbol($j->outfile,true);}if($j->errfile!==2){$jB.=' 2 > '.$j->getFileSymbol($j->errfile,true);}if($eB=shell_exec($jB.' & echo $!')){$eB=trim($eB);$rB->pid=intval($eB);if(!is_null($uB)){file_put_contents($uB,$eB.PHP_EOL,LOCK_EX);}}return$rB->pid;}function loop($u=1,$RC=0,$cD=0){if($RC>0){$RC=intval($RC)+time();}do{$this->execute();if($u>0){$u--;}if($cD>0){usleep($cD*1000000);}}while($u===0||$RC<0||$RC<time());}abstract function execute();}use \Cute\Application;use \Cute\Command;use \Cute\Utility\Inflect;class Console extends Application{const STDIN='php://stdin';const STDOUT='php://stdout';const STDERR='php://stderr';const DEVNULL='/dev/null';const COLOR_BLACK=90;const COLOR_RED=91;const COLOR_GREEN=92;const COLOR_YELLOW=93;const COLOR_BLUE=94;const COLOR_MAGENTA=95;const COLOR_CYAN=96;const COLOR_WHITE=97;protected$color=false;var$outfile=1;var$errfile=null;function initialize(){return$this;}static function getFileSymbol($q,$yC=false){if(is_null($q)){return self::DEVNULL;}else if(is_int($q)){if($q===0){return$yC?'&0':self::STDIN;}else if($q===1){return$yC?'&1':self::STDOUT;}else if($q===2){return$yC?'&2':self::STDERR;}}return strval($q);}static function appendTo($hB,$nB=false,$xB=null){if(empty($xB)&&$xB!==0){return 0;}if(is_int($xB)&&is_int($nB)){$hB=sprintf("\033[%dm%s\033[%dm",$nB,$hB,0);}$xB=self::getFileSymbol($xB);return file_put_contents($xB,$hB,FILE_APPEND|LOCK_EX);}function setColor($nB){if(is_string($nB)){$nB='COLOR_'.strtoupper($nB);$this->color=constant(__CLASS__.'::'.$nB);}return$this;}function write($hB){if(func_num_args()>1){$hB=exec_function_array('sprintf',func_get_args());}return self::appendTo($hB,$this->color,$this->outfile);}function writeln($hB){$B=func_get_args();$B[0].=PHP_EOL;return exec_method_array($this,'write',$B);}function mount($U){$fD=func_get_args();foreach($fD as&$U){$U=rtrim($U,DIRECTORY_SEPARATOR);}$zC=PATH_SEPARATOR.implode(PATH_SEPARATOR,$fD);set_include_path(get_include_path().$zC);return$this;}function run(){if(php_sapi_name()!=='cli'){return;}if($_SERVER['argc']<2){return;}$UB=$_SERVER['argv'];$ND=array_shift($UB);$A=array_shift($UB);$H=Inflect::camelize($A).'Command';@require_once$H.'.php';if(class_exists($H)){$s=new$H($this,$ND,$UB);return$s->execute();}}}class Factory{protected$storage=null;protected$objects=array();function __construct(Storage&$tB){$this->storage=$tB;}function normalize($H){return rtrim($H,'\\');}function create($H,$A='default'){$H=$this->normalize($H);$oC=$this->storage->getSectionOnce($H);$T=$oC->getArray($A);if($A!=='default'){$T=array_merge($oC->getArray('default'),$T);}if(class_exists($H)){foreach($T as$C=>&$D){if(starts_with($C,'\\')){$D=$this->load($C,$D);}}return exec_construct_array($H,array_values($T));}}function load($H,$A='default'){$H=$this->normalize($H);if(!isset($this->objects[$H])){$this->objects[$H]=array();if(!isset($this->objects[$H][$A])){$this->objects[$H][$A]=$this->create($H,$A);}}return$this->objects[$H][$A];}}class Handler{protected$app=null;protected$succor=null;function __construct($sB=null){$this->app=app();$this->succor=$sB;}function init($V){return method_exists($this,$V)?$V:'';}function __invoke(){$V=$this->app->getMethod();$B=func_get_args();if($V=$this->init($V)){return exec_method_array($this,$V,$B);}else if($this->succor){return exec_function_array($this->succor,$B);}else{return$this->app->abort(403);}}}if(!function_exists('trait_exists')){function trait_exists($H,$nC){return false;}}final class Importer{private static$instance=null;private$classes=array();private$namespaces=array();private function __construct(){}static function getInstance(){if(is_null(self::$instance)){self::$instance=new self();self::$instance->register();}return self::$instance;}static function exists($H,$nC=true){return class_exists($H,$nC)||interface_exists($H,$nC)||trait_exists($H,$nC);}function autoload($H){$H=trim($H,'\\_');if(isset($this->classes[$H])){require_once$this->classes[$H];return self::exists($H,false);}$vE=$this->checkNamespace($H);return($vE===true);}function register(){return spl_autoload_register(array($this,'autoload'));}function addClass($R,$H){$pD=func_get_args();$R=array_shift($pD);if(is_readable($R)){foreach($pD as$H){$this->classes[trim($H,'\\')]=$R;}}ksort($this->classes);return$this;}function addNamespaceStrip($t,$Q){$t=trim($t,'\\');$Q=rtrim($Q,'\\/');$this->namespaces[$t]=$Q;ksort($this->namespaces);return$this;}function addNamespace($t,$Q){$t=trim($t,'\\');$aB=strtok($t,'\\_');$Q=rtrim($Q,'\\/').DIRECTORY_SEPARATOR.$aB;return$this->addNamespaceStrip($t,$Q);}function checkNamespace($H){$aB=strtok($H,'\\_');$Z=strlen($aB)+1;if(isset($this->namespaces[$aB])){$U=$this->namespaces[$aB];}else if(isset($this->namespaces[''])){$U=$this->namespaces[''];}else{return false;}$BB=$U.DIRECTORY_SEPARATOR;$BB.=str_replace(array('\\','_'),DIRECTORY_SEPARATOR,substr($H,$Z));if(file_exists($BB.'.php')){require_once$BB.'.php';if(self::exists($H,false)){return true;}}while($aB){$U.=DIRECTORY_SEPARATOR.$aB;if(file_exists($U.'.php')){require_once$U.'.php';if(self::exists($H,false)){return true;}}if(!file_exists($U)){return false;}$aB=strtok('\\_');}}}use \Cute\Context\Router;class Website extends Application{protected$method='';var$url='';var$rule='';function initialize(){$fB=Router::getCurrent();$this->install($fB,array('dispatch','abort','redirect'));$this->install('\\Cute\\Context\\Input',array('getClientIP','input'=>'getInstance',));return$this;}function route($U,$w){$fB=Router::getCurrent();return$fB->route($U,$w);}function mount($r,$VC='*.php'){$fB=Router::getCurrent();$fB->mount($r,$VC);return$this;}function getMethod(){if(empty($this->method)){$cB=$this->input('SERVER');$V=$cB->request('_method','');if(empty($V)){$V=$cB->get('REQUEST_METHOD','GET');}$this->method=strtolower($V);}return$this->method;}function run(){$yE=$this->getConfig('route_key','r');$U=$this->input('GET')->get($yE,'/');try{$lC=$this->dispatch($U);$sB=null;foreach($lC['handlers']as$w){if($w&&class_exists($w,true)){$w=new$w($sB);}if($w&&is_callable($w)){$sB=&$w;}}if($sB){$this->url=$lC['url'];$this->rule=$lC['rule'];$jD=exec_function_array($sB,$lC['args']);}}catch(\Exception$QB){$jD=strval($QB);}return die($jD);}}}
namespace Cute\Base{trait Deferring{protected$UF=false;function defer(){register_shutdown_function(function($rE){$rE->__destruct();},$this);}function __destruct(){if($this->closed===false){$this->close();}$this->closed=true;}function close(){}}trait Mocking{protected$pC=null;private function __construct(&$pC=null){$this->inner=$pC;}static function mock(&$pC=null){$OB=new self($pC);return$OB->isReady()?$OB->inner:$OB;}function __call($A,$_C){return false;}function __set($A,$D){return false;}function __get($A){return;}function isReady(){return!is_null($this->inner);}}use \ArrayObject;class Storage extends ArrayObject{const CONFIG_SECTION_NAME='configs';function __construct($cB=array(),$PF=ArrayObject::ARRAY_AS_PROPS){parent::__construct($cB,$PF);}static function newInstance($R,$vD=false){$R.=empty($vD)?'':$vD;assert(is_readable($R));return new self(include$R);}function getItem($A,$K=null){$mD=$this->offsetGet($A);return is_null($mD)?$K:$mD;}function getArray($A,array$K=array()){$T=$this->getItem($A);return is_array($T)?$T:$K;}function getSection($A){$T=$this->getArray($A,array());return new self($T);}function getSectionOnce($A){$T=$this->getItem($A);if(!($T instanceof self)){$T=new self($T);$this->offsetSet($A,$T);}return$T;}function getConfig($A,$K=null){$oC=$this->getSectionOnce(self::CONFIG_SECTION_NAME);return$oC->getItem($A,$K);}}}
namespace Cute\Context{class Input{protected static$instances=array();protected static$client_ip='-';protected$input_type=null;protected$data=array();protected$done=false;protected function __construct($IB='POST'){$this->input_type=constant('INPUT_'.$IB);if($IB==='REQUEST'){$this->raw_data=$_REQUEST;}assert(!is_null($this->input_type));}function __call($A,$_C){if(starts_with($A,'get')&&count($_C)>0){$F=substr($A,3);@list($C,$K)=$_C;return$this->get($C,$K,$F);}}static function getInstance($IB='POST'){$IB=strtoupper($IB);if(!isset(self::$instances[$IB])){$VB=new static($IB);self::$instances[$IB]=$VB;}return self::$instances[$IB];}static function request($C,$K=null,$F=false){$QF=self::getInstance('POST');$D=$QF->get($C,$K,$F);if($D===$K){$TF=self::getInstance('GET');$D=$TF->get($C,$K,$F);}return$D;}static function getClientIP(){if(strlen(self::$client_ip)>=7){return self::$client_ip;}$UC=array('HTTP_CLIENT_IP','HTTP_X_REAL_IP','HTTP_X_FORWARDED_FOR','HTTP_X_FORWARDED','HTTP_X_CLUSTER_CLIENT_IP','HTTP_FORWARDED_FOR','HTTP_FORWARDED','REMOTE_ADDR');$SF=self::getInstance('SERVER');foreach($UC as$C){$SC=$SF->get($C);if($SC&&strlen($SC)>=7){self::$client_ip=$SC;break;}}return self::$client_ip;}static function detectType($F){$F=empty($F)?'string':strtolower($F);foreach(filter_list()as$A){if(ends_with($A,$F)){return filter_id($A);}}}static function coerce($D,$F='raw'){if(is_array($D)){foreach($D as$C=>$oB){if(is_array($F)&&isset($F[$C])){$nD=$F[$C];}else{$nD=$F;}$D[$C]=self::coerce($oB,$nD);}}else{$F=strtolower($F);if($F==='int'||$F==='float'){settype($D,$F);}else if($F==='array'){$D=(array)$D;}else if($F!=='raw'){settype($D,'string');}}return$D;}protected function filterData($C,$F){$F=self::detectType($F);return filter_input($this->input_type,$C,$F);}protected function filterArrayData($iB){if(is_array($iB)){foreach($iB as$C=>&$F){if(is_array($F)){$F['filter']=self::detectType($F['filter']);}else{$F=self::detectType($F);}}}else{$iB=self::detectType($iB);}return filter_input_array($this->input_type,$iB);}function get($C,$K=null,$F=false){if(!array_key_exists($C,$this->data)){if(is_array($K)){$F=array($C=>array('filter'=>$F,'flags'=>FILTER_FORCE_ARRAY));$T=$this->filterArrayData($F);$this->data=array_merge($this->data,$T);}else{$D=$this->filterData($C,$F);if(is_null($D)||$D===false){$D=self::coerce($K,$F);}$this->data[$C]=$D;}}return$this->data[$C];}function all($C=false,$iB=false){if($this->done===false){$this->data=$this->filterArrayData($iB);}if(is_null($this->data)){$this->data=array();}if($C===false){return$this->data;}else if(array_key_exists($C,$this->data)){return$this->data[$C];}}}use \Cute\Context\Input;class Locale{protected$language='';protected$locale_dir='';protected$timezone='Asia/Shanghai';function __construct($RD='',$KB=''){if(empty($RD)){$RD=APP_ROOT.'/protected/locales';}$this->locale_dir=$RD;$this->timezone=$KB;}function detectLanguage(){$cB=Input::getInstance('SERVER');$JB=strstr($cB->get('LANG',''),'.',true);if(empty($JB)){$EF=$cB->get('HTTP_ACCEPT_LANGUAGE','');preg_match_all('/([a-z]{2}\-?[A-Z]{0,2})/',$EF,$MB);foreach($MB[0]as$JB){$JB=str_replace('-','_',$JB);if(file_exists($this->locale_dir.'/'.$JB)){break;}}}return$JB;}function setLocale($JB,$FD='messages'){if($JB){$this->language=$JB;}else{$this->language=$this->detectLanguage();}putenv('LANG='.$this->language);setlocale(LC_ALL,$this->language);bindtextdomain($FD,$this->locale_dir);bind_textdomain_codeset($FD,'UTF-8');textdomain($FD);return$this->language;}function setTimezone($KB){if($KB){$this->timezone=$KB;}@date_default_timezone_set($this->timezone);return$this->timezone;}}class Router{protected static$current=null;static$aliases=array('<int>'=>'([0-9\-]+)','<float>'=>'([0-9\.\-]+)','<num>'=>'([0-9\.\-,]*)','<string>'=>'([a-z0-9\-_]+)','<page>'=>'([0-9]*)/?([0-9]*)/?','<path>'=>'([a-z0-9\-_/])');protected$filename='';protected$prefix='';protected$children=array();protected$items=array();function __construct($R='',$k='/'){$this->filename=$R;$this->prefix=rtrim($k,'/');self::$current=$this;if($R&&is_readable($R)){include_once$R;}}static function getCurrent(){if(is_null(self::$current)){self::$current=new self();}return self::$current;}static function toPrefix($R){$DF=strstr(basename($R),'.');$CF=substr($R,0,-strlen($DF));$k=str_replace(DIRECTORY_SEPARATOR,'/',$CF);return strtolower(rtrim($k,'/'));}static function compileUrl($RB,$hE=false){$RB=preg_quote(strtolower(rtrim($RB,'/')));$UC=array_map('preg_quote',array_keys(self::$aliases));$N=array_values(self::$aliases);$RB=str_replace($UC,$N,$RB);$VC=($hE===false)?'':'(.*)?';return'!^'.$RB.'/?'.$VC.'$!';}function route($U,&$w){$QC=self::compileUrl($U);if(func_num_args()>2){$YC=array_slice(func_get_args(),1);}else{$YC=array($w);}$this->items[$QC]=$YC;return$QC;}function mount($r,$VC='*.php'){$r=rtrim($r,DIRECTORY_SEPARATOR);$eC=glob($r.'/'.$VC,GLOB_BRACE);if(!empty($eC)){$FE=strlen($r);foreach($eC as$R){$k=self::toPrefix(substr($R,$FE));$this->children[$k]=$R;}}return$this;}function dispatch($U,$lD=false){$U=rtrim(strtolower($U),' /').'/';if(!$lD){krsort($this->children);}foreach($this->children as$k=>$R){if(starts_with($U,$k)){$fB=new self($R,$k);$U=substr($U,strlen($k));return$fB->dispatch($U);}}if(!$lD){krsort($this->items);}foreach($this->items as$QC=>$YC){if(preg_match($QC,$U,$B)===1){$RB=$this->prefix.array_shift($B);return array('handlers'=>&$YC,'args'=>$B,'url'=>$RB,'rule'=>$QC);}}$this->abort(404);return array('handlers'=>array());}function abort($IE=500){return@http_response_code($IE);}function redirect($yD='',$_D=false){$dE=$_D?301:302;@header('Location: '.$yD,true,$dE);return die();}}class Session{}}
namespace Cute\DB{use \DateTime;use \PDO;use \PDOException;use \Cute\DB\Literal;class Database{const ACTION_READ='R';const ACTION_WRITE='W';const TYPE_UNSUPPORT=0;const TYPE_TOP=1;const TYPE_LIMIT=2;protected$pdo=null;protected$dbname='';protected$prefix='';protected$lower_table_name=null;protected$past_sqls=array();function __construct(PDO&$ME,$h='',$k=''){$this->pdo=$ME;if($h){$this->useDB($h,$k);}}function useDB($h,$k='',$sC=false){assert(!is_null($this->pdo));if($sC&&$this->getDriverName()==='mysql'){$this->pdo->exec("CREATE DATABASE IF NOT EXIST `$h`");}$this->pdo->exec("USE `$h`");$this->dbname=$h;$this->prefix=empty($k)?'':$k;$this->lower_table_name=null;if(!array_key_exists($this->dbname,$this->past_sqls)){$this->past_sqls[$this->dbname]=array();}return$this;}function getPDO(){return$this->pdo;}function getDBName(){return$this->dbname;}function getPastSQL($h=false,$TB=0){if($h===true||$h==='*'){return$this->past_sqls;}$h=empty($h)?$this->getDBName():$h;$uD=$this->past_sqls[$h];$TB=empty($TB)?0:-abs($TB);return$TB?array_slice($uD,$TB,null,true):$uD;}function getDriverName(){assert(!is_null($this->pdo));$NB=$this->pdo->getAttribute(PDO::ATTR_DRIVER_NAME);$NB=strtolower($NB);return$NB==='dblib'?'sqlsrv':$NB;}function needTableToLower(){if(is_null($this->lower_table_name)){$ID=$this->getDriverName();if($ID==='mysql'){$G="SHOW Variables LIKE 'lower_case_table_names'";$SE=$this->fetch($G,array(),'Value');$this->lower_table_name=intval($SE)===1;}else{$this->lower_table_name=false;}}return$this->lower_table_name;}function getTableName($M,$jC=false){$Y=$this->prefix.$M;$ID=$this->getDriverName();if($this->needTableToLower()){$Y=strtolower($Y);}if($jC===false){return$Y;}switch($ID){case'mysql':$Y="`$Y`";break;case'sqlite':case'sqlsrv':$Y="[$Y]";break;}return$Y;}function inline($_){return new Literal($_);}function quote($_){if(is_null($this->pdo)||is_null($_)||$_ instanceof Literal||$_ instanceof DateTime){return Literal::quote($_);}else{$F=is_int($_)?PDO::PARAM_INT:PDO::PARAM_STR;return$this->pdo->quote($_,$F);}}function embed($G,array$L=array()){foreach($L as&$_){$_=$this->quote($_);}$G=str_replace('?','%s',$G);return vsprintf($G,$L);}function execute($G,array$L=array()){assert(!is_null($this->pdo));if(!empty($L)){$G=$this->embed($G,$L);}try{$E=$this->pdo->exec($G);}catch(PDOException$QB){$S="SQL: $G\n".$QB->getMessage();throw new PDOException($S);}if(SQL_VERBOSE){$this->past_sqls[$this->dbname][]=array('act'=>self::ACTION_WRITE,'sql'=>$G,);}return$E;}function query($G,array$L=array()){assert(!is_null($this->pdo));try{$P=$this->pdo->prepare($G);if($P->execute($L)){$P->setFetchMode(PDO::FETCH_ASSOC);}}catch(PDOException$QB){$G=$this->embed($G,$L);$S="SQL: $G\n".$QB->getMessage();throw new PDOException($S);}if(SQL_VERBOSE){$G=$this->embed($G,$L);$this->past_sqls[$this->dbname][]=array('act'=>self::ACTION_READ,'sql'=>$G,);}return$P;}function fetch($G,array$L=array(),$zB=false){if($P=$this->query($G,$L)){if(is_numeric($zB)){$E=$P->fetchColumn(intval($zB));}else{$E=$P->fetch();if($E&&$zB){$E=isset($E[$zB])?$E[$zB]:null;}}$P->closeCursor();return$E;}}function listTables(){if(empty($this->prefix)){$G=sprintf("SHOW TABLES FROM %s",$this->getDBName());}else{$b=$this->quote(str_replace('_','\_',$this->prefix).'%');$G=sprintf("SHOW TABLES LIKE %s",$b);}$E=array();if($P=$this->query($G)){$aE=strlen($this->prefix);while($M=$P->fetchColumn(0)){$E[]=substr($M,$aE);}$P->closeCursor();}return$E;}function transact(callable$gE){assert(!is_null($this->pdo));if($this->pdo->beginTransaction()){$B=func_get_args();array_unshift($B,$this);try{$gE($B);$this->pdo->commit();}catch(PDOException$QB){$this->pdo->rollBack();}}}function readFields($M){$NB=$this->getDriverName();$H='\\Cute\\DB\\'.ucfirst($NB).'Schema';$xD=new$H($this,$M);$J=$xD->getColumns();$n=array();$HB=array();foreach($J as$I){if($I->isPrimaryKey()){$n[]=$I->name;}$K=$I->default;$qD=$I->getCategory();if($qD==='int'){$K=intval($K);}else if($qD==='float'){$K=floatval($K);}$HB[$I->name]=$K;}return compact('table','pkeys','fields');}}use \HandlerSocketi;class HandlerSocket{const HS_PORT_R=9998;const HS_PORT_RW=9999;protected$handler=null;protected$query=null;protected$read_only=false;protected$dbname='';protected$table='';protected$fields=array();protected$index=null;function __construct($h,$ED='127.0.0.1',$KC=0,$_E=false){$this->dbname=$h;$this->read_only=$_E;if(empty($KC)){$KC=$this->read_only?self::HS_PORT_R:self::HS_PORT_RW;}$this->handler=new HandlerSocketi($ED,$KC);}function open($M,$HB){if(is_string($HB)){$HB=explode(',',str_replace(' ','',$HB));}$this->table=$M;$this->fields=$HB;$this->query=null;return$this;}protected function prepare($y=null){if(empty($this->query)||$this->index!==$y){$this->index=$y;$HF=empty($this->index)?array():array('index'=>$this->index);$this->query=$this->handler->open_index($this->dbname,$this->table,$this->fields,$HF);}return$this->query;}function insert(array$ZC){$C=$this->index;$E=$this->prepare($C)->insert($ZC);return$E!==false;}function delete($D){if(func_num_args()>1){$C=$D;$D=func_get_arg(1);}else{$C=null;}return$this->prepare($C)->remove($D);}function truncate($aC){$OC=array();$C=null;$aC=is_array($aC)?$aC:func_get_args();foreach($aC as$LB){$OC[]=array('remove',$LB);}$E=$this->prepare($C)->multi($OC);$IF=create_function('$a,$b','return $a && $b;');return array_reduce($E,$IF,true);}function update(array$MC,$C,$D){return$this->prepare($C)->update($D,$MC);}function get($D){if(func_num_args()>1){$C=$D;$D=func_get_arg(1);}else{$C=null;}$E=$this->prepare($C)->find($D);if(empty($E)){return($E===false)?false:null;}return array_combine($this->fields,$E[0]);}function all($C=null,$p='>=',$D=0,$x=0,$TB=0){$TC=array();if($x>0){$TC['limit']=$x;}if($TB>0){$TC['offset']=$TB;}$D=array($p=>$D);$E=$this->prepare($C)->find($D,$TC);if($E===false){return false;}foreach($E as&$d){$d=array_combine($this->fields,$d);}return$E;}function in($C,$D){$OC=array();$N=array_slice(func_get_args(),1);if(count($N)===1&&is_array($N[0])){$N=$N[0];}foreach($N as$D){$OC[]=array('find',$D);}$E=$this->prepare($C)->multi($OC);if($E===false){return false;}$vB=exec_function_array('array_merge',$E);foreach($vB as&$d){$d=array_combine($this->fields,$d);}return$vB;}}class Literal{protected$value;function __construct($D){$this->value=$D;}function __toString(){return strval($this->value);}static function quote($D){$LD="'%s'";if(is_null($D)){$D='NULL';}else if($D instanceof self){$D=strval($D);}else if($D instanceof DateTime){$D=sprintf($LD,$D->format('Y-m-d H:i:s'));}else if(is_string($D)){$D=sprintf($LD,convert($D,'UTF-8'));}else{$D=sprintf($LD,strval($D));}return$D;}}use \Cute\DB\Database;class MssqlSchema{protected$db=null;protected$dbname='';protected$table='';function __construct(Database&$W,$M){$this->db=$W;$this->dbname=$W->getDBName();$this->table=$W->getTableName($M,false);}function getLimitType(){return DB::TYPE_TOP;}function getPKey(){$G="SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.%s WHERE TABLE_SCHEMA='dbo'"." AND TABLE_CATALOG=? AND TABLE_NAME=? ORDER BY ORDINAL_POSITION";$L=array($this->dbname,$this->table);$dB=$this->db->fetch(sprintf($G,'KEY_COLUMN_USAGE'),$L,0);if(empty($dB)){$dB=$this->db->fetch(sprintf($G,'COLUMNS'),$L,0);}return$dB;}function getColumns(){$J=array('COLUMN_NAME','COLUMN_DEFAULT','COLUMN_KEY','IS_NULLABLE','COLUMN_TYPE','DATA_TYPE','CHARACTER_MAXIMUM_LENGTH','NUMERIC_PRECISION','NUMERIC_SCALE','DATETIME_PRECISION',);$G="SELECT %s FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA='dbo'"." AND TABLE_CATALOG=? AND TABLE_NAME=? ORDER BY ORDINAL_POSITION";$G=sprintf($G,implode(', ',$J));$L=array($this->dbname,$this->table);if($P=$this->db->query($G,$L)){$QD=PDO::FETCH_CLASS|PDO::FETCH_PROPS_LATE;$E=$P->fetchAll($QD,'\\Cute\\ORM\\Column');$P->closeCursor();return$E;}}function isExists(){$G="SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo'"." AND TABLE_CATALOG=? AND TABLE_NAME=?";$L=array($this->dbname,$this->table);$M=$this->db->fetch($G,$L,0);return$this->db->getTableName($M,false)===$this->table;}function getCreateSQL($kB,$J=array(),$CD=false,$OD=false){$SB="";$pB="";$l="";$J=$this->getColumns();if($CD||$OD){foreach($J as$I){if($I->getCategory()==='char'){$F="[".$I->type."](".intval($I->length).")";}else if($I->type==='numeric'){$F="[numeric](".$I->precision.", ".$I->scale.")";}else{$F="[".$I->type."]";}if($I->isPrimaryKey()){$SB="    [$A] $F IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,";$pB="PRIMARY KEY NONCLUSTERED ( [$A] ASC )";}else{$RF=$I->isNullable()?"NULL":"NOT NULL DEFAULT ".$I->default;$l.="    [$A] $F $RF,\n";}}}else{foreach($J as$I){$K=trim($I->default,"()");if($I->getCategory()==='char'){$Z=intval($I->length);$F=($Z>255||$Z<0)?"text":"varchar($Z)";}else if($I->getCategory()==='int'){$mB=intval($I->precision);if($K===''){$K="0";}$F=$I->type."($mB)";}else if($I->getCategory()==='float'){$mB=intval($I->precision);$AD=intval($I->scale);if($K===''){$K="0.0";}$F=$I->type;if($I->type==='real'){$F='float';}else if($I->type==='money'){$F='numeric';}$F.="($mB,$AD)";}else if($I->getCategory()==='datetime'){$F='datetime';}else{$F=$I->type;}if($I->isPrimaryKey()){$SB="    [$A] $F IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,";$pB="PRIMARY KEY NONCLUSTERED ( [$A] ASC )";}else if(starts_with($F,'date')||ends_with($F,'text')){$l.="    [$A] $F NULL,\n";}else if($I->isNullable()){$l.="    [$A] $F NULL,\n";}else{$l.="    [$A] $F NOT NULL DEFAULT '$K',\n";}}}$HC=<<<EOD
IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES
    WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='%s')
BEGIN
CREATE TABLE [dbo].[%s] (
%s
%s
    CONSTRAINT [PK_%s]
    %s
    WITH ( PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF,
        ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON )
    ON [PRIMARY]
) ON [PRIMARY]
END
EOD
;if(empty($SB)){$l=rtrim($l,",\n");}$G=sprintf($HC,$kB,$kB,$SB,$l,$kB,$pB);return$G;}function sqlToFile($G,$BB,$gC="\t",$tC=PHP_EOL,$LC='"',$vC=null){@mkdir(dirname($BB),0664,true);$BD=fopen($BB,'wb');$bB=0;$tD=$this->db->query($G);while($d=$tD->fetch()){if(is_null($vC)){fputcsv($BD,$d,$gC,$LC);}else{fwrite($BD,self::csvline($d,$gC,$tC,$LC,$vC));}$bB++;}$tD->closeCursor();fclose($BD);return$bB;}}class MysqlSchema{protected$db=null;protected$dbname='';protected$table='';function __construct(Database&$W,$M){$this->db=$W;$this->dbname=$W->getDBName();$this->table=$W->getTableName($M,false);}function getLimitType(){return DB::TYPE_LIMIT;}function getPKey(){$G="SELECT COLUMN_NAME FROM information_schema.COLUMNS"." WHERE TABLE_SCHEMA=? AND TABLE_NAME=? AND COLUMN_KEY='PRI'";$L=array($this->dbname,$this->table);return$this->db->fetch($G,$L,0);}function getColumns(){$J=array('COLUMN_NAME','COLUMN_DEFAULT','COLUMN_KEY','IS_NULLABLE','COLUMN_TYPE','DATA_TYPE','CHARACTER_MAXIMUM_LENGTH','NUMERIC_PRECISION','NUMERIC_SCALE','DATETIME_PRECISION',);$G="SELECT %s FROM information_schema.COLUMNS"." WHERE TABLE_SCHEMA=? AND TABLE_NAME=? ORDER BY ORDINAL_POSITION";$G=sprintf($G,implode(', ',$J));$L=array($this->dbname,$this->table);if($P=$this->db->query($G,$L)){$QD=PDO::FETCH_CLASS|PDO::FETCH_PROPS_LATE;$E=$P->fetchAll($QD,'\\Cute\\ORM\\Column');$P->closeCursor();return$E;}}function isExists(){$G="SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES"." WHERE TABLE_NAME=? AND (TABLE_SCHEMA=? OR TABLE_CATALOG=?)";$L=array($this->table,$this->dbname,$this->dbname);$M=$this->db->fetch($G,$L,0);return$this->db->getTableName($M,false)===$this->table;}function getCreateSQL($kB,$CD=false,$OD=false){if($CD){$G="CREATE TABLE `%s` LIKE `%s`";return sprintf($G,$kB,$this->table);}else if($OD){$sC=sprintf("CREATE TABLE `%s`",$this->table);$G=$this->db->fetch("SHOW $sC",array(),'Create Table');$G=preg_replace('/(AUTO_INCREMENT=\d+)/','AUTO_INCREMENT=1',$G,1);$AF=sprintf("CREATE TABLE IF NOT EXISTS `%s`",$kB);return str_replace($sC,$AF,$G);}else{$SB="";$pB="";$l="";$J=$this->getColumns();foreach($J as$I){$A=$I->name;$K=trim($I->default,"()");if($I->getCategory()==='char'){$Z=intval($I->length);$F=($Z>255||$Z<0)?"text":"varchar($Z)";}else if($I->getCategory()==='int'){$mB=intval($I->precision);if($K===''){$K="0";}$F=$I->type."($mB)";}else if($I->getCategory()==='float'){$mB=intval($I->precision);$AD=intval($I->scale);if($K===''){$K="0.0";}$F=$I->type;if($I->type==='real'){$F='float';}else if($I->type==='money'){$F='numeric';}$F.="($mB,$AD)";}else if($I->getCategory()==='datetime'){$F='datetime';}else{$F=$I->type;}if($I->isPrimaryKey()){$SB="    `$A` int(10) unsigned NOT NULL AUTO_INCREMENT,";$pB="PRIMARY KEY (`$A`)";}else if(starts_with($F,'date')||ends_with($F,'text')){$l.="    `$A` $F NULL,\n";}else if($I->isNullable()){$l.="    `$A` $F NULL,\n";}else{$l.="    `$A` $F NOT NULL DEFAULT '$K',\n";}}$HC=<<<EOD
CREATE TABLE IF NOT EXISTS `%s` (
%s
%s
    %s
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT
EOD
;if(empty($SB)){$l=rtrim($l,",\n");}$G=sprintf($HC,$kB,$SB,$l,$pB);return$G;}}function sqlToFile($G,$BB,$gC="\t",$tC=PHP_EOL,$LC='"',$vC=null){@mkdir(dirname($BB),0664,true);$fC="FIELDS TERMINATED BY '".addslashes($gC)."'";$fC.=" LINES TERMINATED BY '".addslashes($tC)."'";if($LC){$fC.=" OPTIONALLY ENCLOSED BY '".addslashes($LC)."'";}if($nE){$fC.=" FIELDS ESCAPED BY '".addslashes($nE)."'";}$AC=sys_get_temp_dir().DIRECTORY_SEPARATOR.basename($BB);$iE="$G INTO OUTFILE '$AC' $fC";try{if(file_exists($AC)){unlink($AC);}$this->db->execute($iE);if(file_exists($AC)){rename($AC,$BB);$bB=shell_exec('wc -l '.$BB.' | cut -d" " -f1');$bB=trim($bB);return is_numeric($bB)?intval($bB):0;}}catch(\Exception$QB){}}}}
namespace Cute\Logging{use \Cute\Logging\Logger;defined('LOG_WRITE_FILE_FREQ')or define('LOG_WRITE_FILE_FREQ',1);class FileLogger extends Logger{use\Cute\Base\Deferring;protected$filename='';protected$records=array();function __construct($A='',$r=false,$hC=false){$this->filename=($A?$A.'_':'').'%s.log';if($r===false){$r=realpath('./logs');}if(is_dir($r)||mkdir($r,0777,true)){$this->filename=$r.DIRECTORY_SEPARATOR.$this->filename;}parent::__construct($hC);$this->defer();}function close(){$this->writeFiles();unset($this->records);}function writeFiles(){foreach($this->records as$jE=>&$oD){$q=sprintf($this->filename,$jE);$zC=implode('',$oD);$wB=file_put_contents($q,$zC,FILE_APPEND|LOCK_EX);if($wB!==false){$oD=array();}}}function append(){$qE=implode(' ',func_get_args());$xC=date('Ymd');if(!isset($this->records[$xC])){$this->records[$xC]=array();}array_push($this->records[$xC],$qE.PHP_EOL);}function rawlog($ZB,$S,array$O=array()){$ZB=strtoupper($ZB);if($this->compareLevel($ZB)){$i=self::format($S,$O);$SC=self::getClientIP();$xE=date('Y-m-d H:i:s');$this->append($xE,$SC,$ZB,$i);}if(LOG_WRITE_FILE_FREQ>=1||LOG_WRITE_FILE_FREQ>=mt_rand(1,10000)/10000){$this->writeFiles();}}}use \Cute\Context\Input;abstract class Logger{const EMERGENCY='EMERGENCY';const ALERT='ALERT';const CRITICAL='CRITICAL';const ERROR='ERROR';const WARNING='WARNING';const NOTICE='NOTICE';const INFO='INFO';const DEBUG='DEBUG';protected$threshold=false;protected$threshold_value=null;function __construct($hC=false){if($hC===false){$this->threshold=self::DEBUG;}else{$this->threshold=strtoupper($hC);}}static function format($S,array$O=array()){$i=is_null($S)?'':(string)$S;if(!empty($O)){$kD=array();foreach($O as$C=>$oB){$kD['{'.$C.'}']=$oB;}$i=strtr($i,$kD);}return$i;}static function getClientIP(){return Input::getClientIP();}function compareLevel($ZB){static$iC=array(self::EMERGENCY=>0,self::ALERT=>1,self::CRITICAL=>2,self::ERROR=>3,self::WARNING=>4,self::NOTICE=>5,self::INFO=>6,self::DEBUG=>7,);if(is_null($this->threshold_value)&&isset($iC[$this->threshold])){$this->threshold_value=$iC[$this->threshold];}if(isset($iC[$ZB])){return$iC[$ZB]<=$this->threshold_value;}}function emergency($S,array$O=array()){$this->rawlog(self::EMERGENCY,$S,$O);}function alert($S,array$O=array()){$this->rawlog(self::ALERT,$S,$O);}function critical($S,array$O=array()){$this->rawlog(self::CRITICAL,$S,$O);}function error($S,array$O=array()){$this->rawlog(self::ERROR,$S,$O);}function warning($S,array$O=array()){$this->rawlog(self::WARNING,$S,$O);}function notice($S,array$O=array()){$this->rawlog(self::NOTICE,$S,$O);}function info($S,array$O=array()){$this->rawlog(self::INFO,$S,$O);}function debug($S,array$O=array()){$this->rawlog(self::DEBUG,$S,$O);}abstract function rawlog($ZB,$S,array$O=array());abstract function close();}}
namespace Cute\ORM{use \Cute\ORM\Relation;class BelongsTo extends Relation{protected$foreign_key='';function __construct($c='\\Cute\\ORM\\Model',$M='',$EC=''){parent::__construct($c,$M);$this->foreign_key=$EC;}function getForeignKey($A=''){if(empty($this->foreign_key)){$this->foreign_key=$A.'_id';}return$this->foreign_key;}function relative($A,array&$E){if(empty($E)){return array();}$n=exec_method_array($this->model,'getPKeys');if(empty($n)){return array();}$CB=$this->getForeignKey($A);$N=$this->getAttrs($E,$CB);$PB=$this->newQuery();$PB->combine(reset($n),$N,true);$this->setAttrs($E,$N,$A,$CB);return$N;}}use \Cute\ORM\Model;class Column extends Model{protected static$_keys=array('COLUMN_NAME'=>'name','COLUMN_DEFAULT'=>'default','COLUMN_KEY'=>'index','IS_NULLABLE'=>'nullable','COLUMN_TYPE'=>'column','DATA_TYPE'=>'type','CHARACTER_MAXIMUM_LENGTH'=>'length','NUMERIC_PRECISION'=>'precision','NUMERIC_SCALE'=>'scale','DATETIME_PRECISION'=>'datetime',);var$name='';var$default=null;var$index=null;var$nullable='YES';var$column='';var$type='';var$length=null;var$precision=null;var$scale=null;var$datetime=null;static function getTable(){return'COLUMNS';}function __set($rD,$D){if(isset(self::$_keys[$rD])){$A=self::$_keys[$rD];$this->$A=$D;}}function isPrimaryKey(){return$this->index==='PRI';}function isNullable(){return$this->nullable==='YES';}function getCategory(){if(!is_null($this->datetime)){return'datetime';}else if(!is_null($this->precision)){return$this->scale>0?'float':'int';}else if(!is_null($this->length)){return'char';}else{return$this->type;}}}use \Cute\Utility\Inflect;class HasMany extends Relation{protected$foreign_key='';protected$is_unique=false;function __construct($c='\\Cute\\ORM\\Model',$M='',$EC=''){parent::__construct($c,$M);$this->foreign_key=$EC;}function getForeignKey($A=''){if(empty($this->foreign_key)){$Y=$this->query->getTable();$this->foreign_key=Inflect::singularize($Y).'_id';}return$this->foreign_key;}function relative($A,array&$E){if(empty($E)){return array();}$CB=$this->getForeignKey();$N=$this->getAttrs($E);$PB=$this->newQuery();$PB->combine($CB,$N,$this->is_unique);$K=$this->is_unique?null:array();$this->setAttrs($E,$N,$A,false,$K);return$N;}}use \Cute\ORM\HasMany;class HasOne extends HasMany{protected$is_unique=true;}class ManyToMany extends HasMany{protected$another_foreign_key='';protected$middle_table='';function __construct($c='\\Cute\\ORM\\Model',$M='',$EC='',$GF='',$uE=''){parent::__construct($c,$M,$EC);$this->another_foreign_key=$GF;$this->middle_table=$uE;}function getAnotherForeignKey($A=''){if(empty($this->another_foreign_key)){$this->another_foreign_key=$A.'_id';}return$this->another_foreign_key;}function relative($A,array&$E){if(empty($E)){return array();}$n=exec_method_array($this->model,'getPKeys');if(empty($n)){return array();}$CB=$this->getForeignKey();$N=$this->getAttrs($E);$PB=$this->newQuery('\\Cute\\ORM\\Model',$this->middle_table);$PB->combine($CB,$N,false);$tE=$this->getAnotherForeignKey($A);$cC=array();foreach($N as$C=>$D){foreach($D as$sE=>$oB){$y=$oB->$tE;$N[$C][$sE]=$y;$cC[$y]=null;}}$PB=$this->newQuery();$PB->combine(reset($n),$cC,true);foreach($E as&$s){$C=$s->getID();if(!isset($N[$C])){continue;}$NC=array();foreach($N[$C]as$y){$NC[]=&$cC[$y];}$s->$A=$NC;}return$cC;}}class Model{protected static$_fields=array();static function getTable(){return'';}static function getPKeys(){return array();}function getRelations(){return array();}function getFields(){$M=$this->getTable();if(!isset(self::$_fields[$M])){$HB=get_object_vars($this);foreach($HB as$A=>$K){if(starts_with($A,'_')){unset($HB[$A]);}}self::$_fields[$M]=&$HB;}return self::$_fields[$M];}function getID($WC=0){if($n=$this->getPKeys()){$dB=$n[$WC];return$this->$dB;}}function setID($LB){if($n=$this->getPKeys()){foreach($n as$WC=>$dB){$this->$dB=func_get_arg($WC);}}return$this;}function isExists(){$LB=$this->getID();return$LB!==0&&!is_null($LB);}}use \PDO;use \Cute\DB\Database;use \Cute\View\Templater;class Query{const COUNT_INSERT_BULK_MAX=500;static$protected_fields=array('password','salt','user_pass');protected$db=null;protected$table='';protected$model='';protected$fetch_style=0;protected$constrains=array();protected$parameters=array();protected$total=-1;protected$offset=0;protected$length=-1;protected$additions=array('GROUP BY'=>null,'HAVING'=>null,'ORDER BY'=>null,);protected$relations=array();function __construct(Database&$W,$c='\\Cute\\ORM\\Model',$M=''){$this->db=$W;if(is_object($c)){$this->model=get_class($c);}else{$this->model=$c;}$this->fetch_style=PDO::FETCH_CLASS;if(method_exists($this->model,'__set')||method_exists($this->model,'__construct')){$this->fetch_style=$this->fetch_style|PDO::FETCH_PROPS_LATE;}if(empty($M)||$this->model!=='\\Cute\\ORM\\Model'){$this->table=exec_method_array($this->model,'getTable');}else{$this->table=$M;}}function __call($A,$B){$J=empty($B)?'':implode(', ',$B);$A=str_replace('_',' ',strtoupper($A));if($A==='GROUPBY'||$A==='ORDERBY'){$A=substr($A,0,-2).' BY';}if(array_key_exists($A,$this->additions)){$this->additions[$A]=$J;$this->total=-1;return$this;}else{$P=$this->select("$A($J)");$T=$P->fetchColumn();$P->closeCursor();return$T;}}static function generateModel(Database&$W,$M,$A='',$t='',$wE=false){$T=$W->readFields($M);if(empty($A)){$A=$wE?Inflect::singularize($M):$M;$A=Inflect::camelize($A);}$Q=APP_ROOT.'/models';if($t){$Q.='/'.str_replace('\\','/',trim($t));}if(!file_exists($Q)){mkdir($Q,0777,true);}$R="$Q/$A.php";$T['name']=$A;$T['ns']=$t;$T['protecteds']=self::$protected_fields;$HC=new Templater(SRC_ROOT);ob_start();$HC->render('model_tpl.php',$T);$i="<?php\n\n".trim(ob_get_clean());file_put_contents($R,$i);return$R;}function getDB(){return$this->db;}function getModel(){return$this->model;}function getTable($jC=null){if(is_null($jC)){return$this->table;}else{assert($W=$this->getDB());return$W->getTableName($this->table,$jC);}}function join($A='*'){$c=exec_construct_array($this->model);$uC=$c->getRelations();if($A==='*'){$this->relations=&$uC;}else{$zE=func_get_args();foreach($zE as$A){if($A&&isset($uC[$A])){$this->relations[$A]=&$uC[$A];}}}return$this;}function contain($iD,array$N){$GB=count($N);if($GB===0){$p='IS NULL';}else if($GB===1){$p='= ?';}else{$XB=implode(', ',array_fill(0,count($N),'?'));$p='IN ('.$XB.')';}$N=array_values($N);$this->constrains[]="$iD $p";$this->parameters=array_merge($this->parameters,$N);$this->total=-1;return$this;}function filter($a,$D,$p='= ?'){$p=empty($p)?false:strtoupper($p);if(is_array($D)){if(substr_count($a,'?')===count($D)){$this->constrains[]="$iD $p";$this->parameters=array_merge($this->parameters,$D);}else{$this->contain($a,$D);}}else if(is_null($D)){if(trim($p)==='<>'){$this->constrains[]="$a IS NOT NULL";}else{$this->constrains[]="$a IS NULL";}}else{$this->constrains[]=($p===false)?$a:"$a $p";$this->parameters[]=$D;}$this->total=-1;return$this;}function setPage($aD,$YB=1){$this->length=intval($aD)<0?-1:intval($aD);if($this->length>0){$YB=intval($YB);if($YB>0){$this->offset=($YB-1)*$this->length;}else if($YB<0){$eD=ceil($this->count()/$this->length);if($eD>0&&($YB=$YB+$eD)>0){$this->offset=$YB*$this->length;}}}return$this;}function count($J='*'){if($this->total===false||$this->total<0){$P=$this->select("COUNT($J)");$this->total=$P->fetchColumn();$P->closeCursor();}return$this->total;}protected function where($a='',array&$B=array()){$m=implode(' AND ',$this->constrains);$L=$this->parameters;if($a||count($B)>0){$m.=($m?' AND ':'').$a;$L=array_merge($L,$B);}$m=$m?'WHERE '.$m:'';return array($m,$L);}protected function getTail($VF=''){$kE=func_get_args();$BC="";foreach($this->additions as$C=>$D){if(!is_null($D)&&!in_array($C,$kE)){$BC.=" $C $D";}}return$BC;}protected function getLimit(){if($this->length<=0){return array("","");}$yB="";$x="";$NB=$this->getDB()->getDriverName();if($NB==='sqlsrv'){$yB=sprintf("TOP %d ",$this->length);}else if($NB==='mysql'){if($this->offset>0){$x=sprintf(" LIMIT %d, %d",$this->offset,$this->length);}else{$x=sprintf(" LIMIT %d",$this->length);}}return array($yB,$x);}function select($J='*',$a='',array&$B=array()){$Y=$this->getTable(true);list($m,$L)=$this->where($a,$B);if(is_object($J)){$J=get_object_vars($J);}if(is_array($J)){array_walk($J,create_function('&$v,$k','if(!is_numeric($k))$v.=" as ".$k;'));$J=implode(', ',$J);}$J=trim($J);if(starts_with($J,'COUNT')){$BC=$this->getTail('ORDER BY');$yB="";$x="";}else{$BC=$this->getTail();list($yB,$x)=$this->getLimit();}$G="SELECT $yB$J FROM $Y";$G.=($m?' '.$m:'').$BC.$x;$W=$this->getDB();return$W->query(rtrim($G),$L);}function rows($C=false,$J='*',$a=''){$B=array_slice(func_get_args(),3);if($P=$this->select($J,$a,$B)){$E=array();if($C===false||is_null($C)){$E=$P->fetchAll();}else{while($d=$P->fetch()){$E[$d[$C]]=$d;}}$P->closeCursor();return$E;}}function all($J='*',$a=''){$B=array_slice(func_get_args(),2);if($P=$this->select($J,$a,$B)){$E=$P->fetchAll($this->fetch_style,$this->getModel());$P->closeCursor();foreach($this->relations as$A=>&$lE){$lE->bind($this)->relative($A,$E);}}return$E;}function combine($CB,array&$E,$mE=false,$J='*'){if(empty($CB)||count($E)===0){return$E;}$this->contain($CB,array_keys($E));if($J==='*'){$J=sprintf('%s,%s.*',$CB,$this->getTable(false));}if($P=$this->select($J)){$pE=$mE?PDO::FETCH_UNIQUE:PDO::FETCH_GROUP;$oE=$this->fetch_style|$pE;$E=$P->fetchAll($oE,$this->getModel());$P->closeCursor();}return$E;}function get($LB,$C=false,$J='*'){if(empty($C)){$n=exec_method_array($this->getModel(),'getPKeys');if(empty($n)){return;}$C=reset($n);}$NC=$this->setPage(1)->all($J,"$C = ?",$LB);return count($NC)>0?reset($NC):null;}function delete($a=''){$B=array_slice(func_get_args(),1);$Y=$this->getTable(true);list($m,$L)=$this->where($a,$B);$G="DELETE FROM $Y $m";$W=$this->getDB();if(empty($m)&&$W->getDriverName()==='mysql'){$G="TRUNCATE $Y";}return$W->execute(rtrim($G),$L);}function getUpdateSet(array$MC){$VD=array();$N=array();foreach($MC as$C=>$oB){$VD[]=$C.'=?';$N[]=$oB;}$wC="SET ".implode(', ',$VD);return array($wC,$N);}function update(array$MC,$WB=false,$a=''){$B=array_slice(func_get_args(),3);$Y=$this->getTable(true);list($m,$L)=$this->where($a,$B);list($wC,$N)=$this->getUpdateSet($MC);$DC=$WB?'UPDATE DELAYED':'UPDATE';$G="$DC $Y $wC $m";$L=array_merge($N,$L);return$this->getDB()->execute(rtrim($G),$L);}function getInsertSQL(array$J,$WB=false,$FC=false){$Y=$this->getTable(true);if($FC===true){$DC=$WB?'REPLACE DELAYED':'REPLACE INTO';}else{$DC=$WB?'INSERT DELAYED':'INSERT INTO';}if($GB=count($J)){$J=implode(',',$J);$XB=implode(', ',array_fill(0,$GB,'?'));return array("$DC $Y ($J)",$XB);}else{return array("$DC $Y",'');}}function insert(array$ZC,$WB=false,$FC=false){assert($W=$this->getDB());list($G,$XB)=$this->getInsertSQL(array_keys($ZC),$WB,$FC);if(!empty($XB)){$G.=" VALUES ($XB)";$L=array_values($ZC);if($W->execute($G,$L)){return$W->getPDO()->lastInsertId();}}}function insertBulk(array$vB,array$J=null,$WB=false,$FC=false){assert(count($vB)>0);$Y=$this->getTable(true);if(empty($J)){$J=array_keys(reset($vB));}list($G,$XB)=$this->getInsertSQL($J,$WB,$FC);$OF=array_chunk($vB,self::COUNT_INSERT_BULK_MAX);foreach($OF as$TD){$NF=array_fill(0,count($TD),"($XB)");$G.=" VALUES ".implode(', ',$NF);$MF=array_map('array_values',$TD);$L=exec_funcution_array('array_merge',$MF);$this->getDB()->execute($G,$L);}}}use \Cute\ORM\Query;abstract class Relation{protected$query=null;protected$model='';protected$table='';function __construct($c='\\Cute\\ORM\\Model',$M=''){$this->model=$c;$this->table=$M;}function bind(Query&$PB){$this->query=$PB;return$this;}function newQuery($c='',$M=''){assert($W=$this->query->getDB());if(empty($c)){$c=&$this->model;}if(empty($M)){$M=$this->table;}return new Query($W,$c,$M);}protected function getAttrs(array&$E,$GC=false){$hD=array();foreach($E as&$s){$C=$GC?$s->$GC:$s->getID();$hD[$C]=null;}return$hD;}protected function setAttrs(array&$E,array&$N,$A,$GC=false,$K=null){foreach($E as&$s){$C=$GC?$s->$GC:$s->getID();if(isset($N[$C])){$s->$A=&$N[$C];}else{$s->$A=$K;}}}abstract function relative($A,array&$E);}}
namespace Cute\Utility{class Date extends\DateTime{protected$timestamp=0;function __construct($PD='now',$KB=null){if(is_null($KB)&&$K=constant('DEFAULT_TIMEZONE')){$KB=new\DateTimeZone($K);}if(is_numeric($PD)){parent::__construct('now',$KB);$this->setTimestamp($PD);}else{parent::__construct($PD,$KB);}}static function parseDurtion($FB){if(empty($FB)){return 0;}if(is_int($FB)||is_float($FB)){return$FB;}if(is_string($FB)){$WD=strtolower(substr($FB,-1));if(is_numeric($WD)){return floatval($FB);}$FB=trim(substr($FB,0,-1));$u=1;switch($WD){case'w':$u*=7;case'd':$u*=24;case'h':$u*=60;case'm':$u*=60;}return floatval($FB)*$u;}}function thisMonthBegin(){return new self($this->format('Y-m-01'));}function thisMonthEnd(){return new self($this->format('Y-m-01').' +1 month -1 day');}function nextMonthBegin(){return new self($this->format('Y-m-01').' +1 month');}}class Inflect{protected static$plural=array('/(quiz)$/i'=>"$1zes",'/^(ox)$/i'=>"$1en",'/([m|l])ouse$/i'=>"$1ice",'/(matr|vert|ind)ix|ex$/i'=>"$1ices",'/(x|ch|ss|sh)$/i'=>"$1es",'/([^aeiouy]|qu)y$/i'=>"$1ies",'/(hive)$/i'=>"$1s",'/(?:([^f])fe|([lr])f)$/i'=>"$1$2ves",'/(shea|lea|loa|thie)f$/i'=>"$1ves",'/sis$/i'=>"ses",'/([ti])um$/i'=>"$1a",'/(tomat|potat|ech|her|vet)o$/i'=>"$1oes",'/(bu)s$/i'=>"$1ses",'/(alias)$/i'=>"$1es",'/(octop)us$/i'=>"$1i",'/(ax|test)is$/i'=>"$1es",'/(us)$/i'=>"$1es",'/s$/i'=>"s",'/$/'=>"s");protected static$singular=array('/(quiz)zes$/i'=>"$1",'/(matr)ices$/i'=>"$1ix",'/(vert|ind)ices$/i'=>"$1ex",'/^(ox)en$/i'=>"$1",'/(alias)es$/i'=>"$1",'/(octop|vir)i$/i'=>"$1us",'/(cris|ax|test)es$/i'=>"$1is",'/(shoe)s$/i'=>"$1",'/(o)es$/i'=>"$1",'/(bus)es$/i'=>"$1",'/([m|l])ice$/i'=>"$1ouse",'/(x|ch|ss|sh)es$/i'=>"$1",'/(m)ovies$/i'=>"$1ovie",'/(s)eries$/i'=>"$1eries",'/([^aeiouy]|qu)ies$/i'=>"$1y",'/([lr])ves$/i'=>"$1f",'/(tive)s$/i'=>"$1",'/(hive)s$/i'=>"$1",'/(li|wi|kni)ves$/i'=>"$1fe",'/(shea|loa|lea|thie)ves$/i'=>"$1f",'/(^analy)ses$/i'=>"$1sis",'/((a)naly|(b)a|(d)iagno|(p)arenthe|(p)rogno|(s)ynop|(t)he)ses$/i'=>"$1$2sis",'/([ti])a$/i'=>"$1um",'/(n)ews$/i'=>"$1ews",'/(h|bl)ouses$/i'=>"$1ouse",'/(corpse)s$/i'=>"$1",'/(us)es$/i'=>"$1",'/s$/i'=>"");protected static$irregular=array('move'=>'moves','foot'=>'feet','goose'=>'geese','sex'=>'sexes','child'=>'children','man'=>'men','tooth'=>'teeth','person'=>'people');protected static$uncountable=array('sheep','fish','deer','series','species','money','rice','information','equipment');protected static$abbreviations=array('AD','API','B2B','B2C','C2C','CEO','CFO','COO','CTO','DB','DSA','GEO','GPS','HTML','HTTP','ID','IO','IP','IQ','MD5','MTV','MV','MVC','NBA','OK','P2P','PC','PV','PDF','PHP','QQ','RMB','RSA','SOHO','SHA','SQL','TV','UI','URI','URL','USA','VIP','WC','WEB','WAP','WIFI','XML',);static function pluralize($X){if(in_array(strtolower($X),self::$uncountable))return$X;foreach(self::$irregular as$b=>$E){$b='/'.$b.'$/i';if(preg_match($b,$X))return preg_replace($b,$E,$X);}foreach(self::$plural as$b=>$E){if(preg_match($b,$X))return preg_replace($b,$E,$X);}return$X;}static function singularize($X){if(in_array(strtolower($X),self::$uncountable))return$X;foreach(self::$irregular as$E=>$b){$b='/'.$b.'$/i';if(preg_match($b,$X))return preg_replace($b,$E,$X);}foreach(self::$singular as$b=>$E){if(preg_match($b,$X))return preg_replace($b,$E,$X);}return$X;}static function pluralizeIf($GB,$X){if($GB==1)return"1 $X";else return$GB." ".self::pluralize($X);}static function camelize($X,$LF=false){$CC=explode('_',$X);if($LF){$YD=count($CC)-1;$CC[$YD]=self::pluralize($CC[$YD]);}foreach($CC as&$e){$e=ucfirst($e);if(strlen($e)>1&&strlen($e)<=4){$SD=strtoupper($e);if(in_array($SD,self::$abbreviations)){$e=$SD;}}}return implode('',$CC);}static function flatten($X,$BF='_'){$b='/([A-Z][A-Z0-9]*(?=$|[A-Z][a-z0-9])|[A-Za-z][a-z0-9]+)/';preg_match_all($b,$X,$MB);return strtolower(implode($BF,$MB[0]));}}class Polling{protected$channels=array();function __construct(array$FF=array()){$this->channels=$FF;}function randRoll(){static$y=0;if($y===0){shuffle($this->channels);$y=count($this->channels);}return$this->channels[--$y];}function roundRobin(&$bC,$JF=1){if(count($this->channels)<2){return current($this->channels);}$XC=null;$UD=0;$MD=0;foreach($this->channels as$LB=>$d){$bD=$d['weight']*$JF;$MD+=$bD;$d['last_value']+=$bD;if(empty($bC)&&$d['last_value']>=$UD){$XC=$LB;$UD=$d['last_value'];}}if(!empty($bC)){$this->channels[$bC]['last_value']-=$MD;return$this->channels[$bC];}else if(!is_null($XC)){$this->channels[$XC]['last_value']-=$MD;return$this->channels[$XC];}}}class Word{protected$content='';function __construct($i=''){$this->content=$i;}static function randHash($Z=6){$Z=$Z>32?32:$Z;$ZE=md5(mt_rand().time());$EE=substr($ZE,0,$Z);return$EE;}static function randString($Z=6,$DE=2,$IC=''){if(empty($IC)){$IC='abcdefghijkmnpqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ23456789';}srand((float)microtime()*1000000);$dD='';$qC=ceil($Z/$DE);while($Z>0){$IC=str_shuffle($IC);$dD.=substr($IC,0,$qC);$Z-=$qC;$qC=min($Z,$qC);}return$dD;}function hasNonASCII(){return preg_match('/[^\x20-\x7f]/',$this->content);}function fetchFirstURL(){if(preg_match('/^http[^\x23-\x76]/i',$this->content,$MB)){return$MB[1];}}function getNumbers($GE=true){$u=preg_match_all('/[\d.]+/',$this->content,$MB);if($u===0||$u===false){return false;}$ZD=implode(current($MB));return$GE?intval($ZD):$ZD;}function ver2int(){$BE=$this->getNumbers(false);$DD=array_map('intval',explode('.',$BE));$DD=array_pad($DD,3,0);return intval(vsprintf('%d%02d%02d',$DD));}}}
namespace Cute\View{class Compiler{protected$env=null;protected$source_dir='';protected$compiled_dir='';function __construct(){\app()->import('Twig',VENDOR_ROOT.'/Twig/lib');$this->env=new\Twig_Environment();}function addFunction($A,$HE=null){$KE=new\Twig_SimpleFunction($A,$HE);return$this->env->addFunction($A,$KE);}function setSourceDir($JC){$this->source_dir=rtrim($JC,' /\\');if(!file_exists($this->source_dir)){@mkdir($this->source_dir,0777,true);}$wD=new\Twig_Loader_Filesystem(array($this->source_dir));$this->env->setLoader($wD);return$this;}function setCompiledDir($g){$g=rtrim($g,' /\\');if($this->compiled_dir!==$g){$this->compiled_dir=$g;}if(!file_exists($this->compiled_dir)){@mkdir($this->compiled_dir,0777,true);}return$this;}function isSourceRelational(){return true;}function compileFile($gB,$_B,array$O=array()){$i=$this->env->loadTemplate($gB)->render($O);file_put_contents($_B,$i,LOCK_EX);}function compileTpl($f,$gB='',array$O=array()){$f=ltrim(str_replace('\\','/',$f),'/');if(empty($gB)){$gB=$this->source_dir.'/'.$f;}$_B=$this->compiled_dir.'/'.$f;$g=dirname($_B);if(!is_dir($g)){mkdir($g,0777,true);}if($this->isSourceRelational()){$gB=substr($gB,strlen($this->source_dir)+1);}$this->compileFile($gB,$_B,$O);return$_B;}function compileAll($Q=false,array$O=array()){if(is_null($Q)||$Q===false){$Q=$this->source_dir;}else{$Q=rtrim(str_replace('\\','/',$Q),'/');}$GB=0;$JE=scandir($Q);foreach($JE as$KD){if($KD==='.'||$KD==='..'){continue;}$mC=$Q.'/'.$KD;if(is_dir($mC)){$this->compileAll($mC);}else{$f=substr($mC,strlen($this->source_dir));$this->compileTpl($f,$mC,$O);$GB++;}}return$GB;}}use \Cute\View\Compiler;class Templater{var$compiler=null;var$globals=array();protected$source_dir='';protected$extend_files=array();protected$template_blocks=array();protected$current_block='';function __construct($JC,$g=false){$this->setSourceDir($JC);if($g){$this->setCompileDir($g);}}static function replaceWith($i,array$O=array()){if(!empty($O)){$i=strtr($i,$O);}return$i;}function setSourceDir($JC){$this->source_dir=rtrim($JC,' /\\');if(!file_exists($this->source_dir)){@mkdir($this->source_dir,0777,true);}}function setCompileDir($g){if(is_null($this->compiler)){$this->compiler=new Compiler();}$g=rtrim($g,' /\\');$this->compiler->setSourceDir($this->source_dir);$this->compiler->setCompiledDir($g);$this->setSourceDir($g);return$this;}function updateGlobals(array$LE){if(func_num_args()===1){$this->globals=array_merge($this->globals,$LE);}else{$B=func_get_args();array_unshift($B,$this->globals);$this->globals=exec_function_array('array_merge',$B);}return$this;}function updateFunctions(array$YE){$XE=$this->compiler;foreach($YE as$A=>$o){$XE->addFunction($A,$o);}}function prepareFile($f){if($this->compiler){return$this->compiler->compileTpl($f,'',$this->globals);}else{return$this->source_dir.'/'.$f;}}function render($f,array$O=array()){extract($this->globals);extract($O);include$this->prepareFile($f);if(!empty($this->extend_files)){$bE=array_pop($this->extend_files);foreach($this->extend_files as$q){include$this->prepareFile($q);}extract($this->template_blocks);include$this->prepareFile($bE);}}function extendTpl($f){array_push($this->extend_files,$f);}function includeTpl($f,array$O=array()){extract($this->globals);extract($O);ob_start();include$this->prepareFile($f);$cE=trim(ob_get_clean());echo$cE;}function blockStart($fE='content'){$this->current_block=$fE;ob_start();}function blockEnd(){$eE=trim(ob_get_clean());$this->template_blocks[$this->current_block]=$eE;}}}
namespace Cute\Widget{use \Cute\Utility\Word;class Captcha{const ENCRYPT_SALT='captcha_code_salt';const FILENAME_PREFIX='cc_';var$phrase_size=6;var$width=80;var$height=30;var$font=null;var$finger_print=null;protected$builder=null;protected$savedir='';protected$saveurl='';function __construct($AB=''){\app()->import('Gregwar',VENDOR_ROOT);$this->builder=new\Gregwar\Captcha\CaptchaBuilder();if(!empty($AB)){$this->phrase_size=strlen($AB);$this->builder->setPhrase($AB);}else{$this->refresh();}$this->savedir=APP_ROOT.'/public/assets/captcha';@mkdir($this->savedir,0755,true);$this->saveurl=app()->getAssetURL().'/captcha';}static function newInstance($WE=6,$VE=80,$PE=30,$OE=null,$NE=null){$VB=new self();$VB->phrase_size=$WE;$VB->width=$VE;$VB->height=$PE;$VB->font=$OE;$VB->finger_print=$NE;return$VB;}protected static function encrypt($AB){return md5(strtolower($AB).self::ENCRYPT_SALT);}static function clean($Q,$JD=0.3,$x=60){$QE=mt_rand(1,10000)/10000;if($JD<=0||$JD>=1||$QE<=$JD){$RE=time()-$x;$eC=glob($Q.'cc_*.jpg');foreach($eC as$q){if(fileatime($q)<$RE){unlink($q);}}}}function refresh(){$AB=Word::randString($this->phrase_size);$this->builder->setPhrase($AB);return$this;}function build(array$B=array()){$UE=array($this->width,$this->height,$this->font,$this->finger_print,);exec_method_array($this->builder,'build',$B+$UE);return$this->builder;}function show(){@session_start();$AB=$this->builder->getPhrase();$_SESSION['phrase']=self::encrypt($AB);@header('Content-Type: image/jpeg');$this->build(func_get_args());return$this->builder->output();}function save(){self::clean($this->savedir,0.3,60);$R=uniqid(self::FILENAME_PREFIX).'.jpg';$this->build(func_get_args());$this->builder->save($this->savedir.'/'.$R);$AB=$this->builder->getPhrase();$RB=$this->saveurl.'/'.$R.'#'.self::encrypt($AB);die($RB);}}use \Cute\Widget\RedisCounter;use \Cute\Widget\FileCounter;abstract class Counter{protected$name='';protected$value=0;protected$maxium=0;function __construct($A,$D=0,$rC=0){$this->name=$A;$this->value=intval($D);$this->maxium=intval($rC);}static function newInstance($A,$D=0,$rC=0){$OB=new RedisCounter($A,$D,$rC);if(!$OB->connect()){$OB=new FileCounter($A,$D,$rC);$OB->connect();}$OB->readValue();return$OB;}function increase($TE=1){$this->value+=$TE;if($this->maxium>0){$this->value=$this->value%$this->maxium;}$this->writeValue();return$this->value;}abstract function connect();abstract function readValue();abstract function writeValue();abstract function remove();}use \Cute\Widget\Counter;class FileCounter extends Counter{protected$filename='';function connect($Q=false){if(empty($Q)&&$Q!==''){$Q=sys_get_temp_dir();}else{$Q=rtrim(str_replace('\\','/',$Q),'/');}$this->filename=$Q.'/'.$this->name.'.txt';if(!is_readable($this->filename)){$lB=touch($this->filename);}else{$lB=true;}if(!$lB){$this->filename='';}return$lB;}function readValue(){$D=false;$wB=filesize($this->filename);if($wB>0){$D=file_get_contents($this->filename);}if($D!==false&&strlen(trim($D))>0){$this->value=intval($D);}else{$this->writeValue();}return$this->value;}function writeValue(){$wB=file_put_contents($this->filename,$this->value);return$wB&&$wB>0;}function remove(){if(file_exists($this->filename)){return unlink($this->filename);}}}class RedisCounter extends Counter{protected$redis=null;function connect($ED='127.0.0.1',$KC=6379){if(!extension_loaded('redis')){return false;}$this->redis=new\Redis();try{$lB=$this->redis->connect($ED,$KC);}catch(Exception$QB){$lB=false;}if(!$lB){$this->redis=null;}return$lB;}function readValue(){$D=$this->redis->get($this->name);if($D!==false&&strlen(trim($D))>0){$this->value=intval($D);}else{$this->writeValue();}return$this->value;}function writeValue(){return$this->redis->set($this->name,$this->value);}function remove(){if($this->redis->exists($this->name)){$E=$this->redis->del($this->name);$this->redis->close();return$E;}}}}