<?php
namespace{defined('VENDOR_ROOT')or define('VENDOR_ROOT',APP_ROOT.'/vendor');defined('APP_CLASS')or define('APP_CLASS','\\Cute\\Website');defined('ERROR_LEVEL')or define('ERROR_LEVEL',E_ALL&~E_DEPRECATED&~E_NOTICE);@error_reporting(ERROR_LEVEL);if(!class_exists('\\Cute\\Importer')){require_once SRC_ROOT.'/Cute/Importer.php';}function app($XD=''){static$g=null;if(is_null($g)&&$XD){$VD=\Cute\Importer::getInstance();$VD->addNamespace('Cute',SRC_ROOT);$oB=\Cute\Base\Storage::newInstance($XD);$H=constant('APP_CLASS');$g=new$H($oB);$g->install($VD,array('import'=>'addNamespace'));$g->initialize();}return$g;}function starts_with($iC,$MC){return strncmp($iC,$MC,strlen($MC))===0;}function ends_with($iC,$MC){$yC=strlen($MC);return$yC===0||(strlen($iC)>=$yC&&substr_compare($iC,$MC,-$yC)===0);}function convert($e,$nB='UTF-8'){$nB=strtoupper($nB);if(function_exists('mb_detect_encoding')){return mb_detect_encoding($e,$nB,true)?$e:mb_convert_encoding($e,$nB,'UTF-8, GBK');}else if(function_exists('iconv')){$LE=$nB==='UTF-8'?'GBK':'UTF-8';return iconv($LE,$nB.'//IGNORE',$e);}}function b64decode($e){if(preg_match('!([A-Za-z0-9+/= ]+)!',$e,$GB)){$e=$GB[1];}return base64_decode($e);}function exec_function_array($m,array$A=array()){switch(count($A)){case 0:return$m();case 1:return$m($A[0]);case 2:return$m($A[0],$A[1]);case 3:return$m($A[0],$A[1],$A[2]);case 4:return$m($A[0],$A[1],$A[2],$A[3]);case 5:return$m($A[0],$A[1],$A[2],$A[3],$A[4]);default:if(is_object($m)){$w=new ReflectionMethod($m,'__invoke');return$w->invokeArgs($m,$A);}else if(is_callable($m)){$w=new ReflectionFunction($m);return$w->invokeArgs($A);}}}function exec_method_array($AB,$V,array$A=array()){if(is_object($AB)){switch(count($A)){case 0:return$AB->{$V}();case 1:return$AB->{$V}($A[0]);case 2:return$AB->{$V}($A[0],$A[1]);case 3:return$AB->{$V}($A[0],$A[1],$A[2]);case 4:return$AB->{$V}($A[0],$A[1],$A[2],$A[3]);case 5:return$AB->{$V}($A[0],$A[1],$A[2],$A[3],$A[4]);}}if(method_exists($AB,$V)){$w=new ReflectionMethod($AB,$V);if($w->isPublic()&&!$w->isAbstract()){if($w->isStatic()){return$w->invokeArgs(null,$A);}else{return$w->invokeArgs($AB,$A);}}}}function exec_construct_array($H,array$A=array()){switch(count($A)){case 0:return new$H();case 1:return new$H($A[0]);case 2:return new$H($A[0],$A[1]);case 3:return new$H($A[0],$A[1],$A[2]);case 4:return new$H($A[0],$A[1],$A[2],$A[3]);case 5:return new$H($A[0],$A[1],$A[2],$A[3],$A[4]);default:if(class_exists($H)){$w=new ReflectionClass($H);return$w->newInstanceArgs($A);}}}}
namespace Cute{use \Cute\Importer;use \Cute\Factory;use \Cute\Base\Storage;abstract class Application{protected$shortcuts=array();function __construct(Storage&$oB){$this->install($oB,array('getConfig'));$FE=new Factory($oB);$this->install($FE,array('load'));}function initialize(){return$this;}function install($rC,array$IE){foreach($IE as$fC=>$V){$fC=strtolower(is_numeric($fC)?$V:$fC);$this->shortcuts[$fC]=array($rC,$V);}return$this;}function __call($D,$A){$D=strtolower($D);if(isset($this->shortcuts[$D])){list($rC,$V)=$this->shortcuts[$D];return exec_method_array($rC,$V,$A);}}abstract function run();}abstract class Command{protected$app=null;protected$args=array();protected$pid=0;var$cmdfile='';function __construct($g,$xC,array$OB=array()){$this->app=$g;$this->cmdfile=$xC;list($A,$x)=self::parse($OB);$this->args=array_merge($A,$x);}function __clone(){$this->args=array_change_key_case($this->args);}function __toString(){$A=array();foreach($this->args as$B=>$C){if(is_numeric($B)){$A[]=$C;}else if($C===true){$A[]=strlen($B)===1?" -$B":" --$B";}else{$A[]=" --$B='$C'";}}$aB=$this->cmdfile;$aB.=' '.substr(__CLASS__,0,-strlen('Command'));$aB.=' '.implode(' ',$A);return$aB;}static function parse(array$OB){$A=array();$x=array();foreach($OB as$JC=>$u){$u=trim($u);if($u==='--'){$A[]=implode(' ',array_slice($OB,$JC+1));break;}if(substr($u,0,1)!=='-'){$A[]=$u;}else if(substr($u,1,1)!=='-'){$KC=str_split(substr($u,1));foreach($KC as$B){$x[$B]=true;}}else{if(($aD=strpos($u,'='))!==false){$B=substr($u,2,$aD-2);$C=substr($u,$aD+1);}else{$B=substr($u,2);$C=true;}if(!array_key_exists($B,$x)){$x[$B]=$C;}else{if(!is_array($x[$B])){$x[$B]=array($x[$B]);}$x[$B][]=$C;}}}return array($A,$x);}function addArg($C,$B=false){if($B===false||is_null($B)){$this->args[]=$C;}else{$this->args[$B]=$C;}return$this;}function getArg($B=false,$L=null){if($B===false||is_null($B)){return$this->args;}if(isset($this->args[$B])){return$this->args[$B];}else{return$L;}}function popArg($B){if($B===false||is_null($B)){return;}if(isset($this->args[$B])){$C=$this->args[$B];unset($this->args[$B]);return$C;}}function readPid($mB=null){if(!is_null($mB)&&is_readable($mB)){$ZB=trim(file_get_contents($mB));if(is_numeric($ZB)){$this->pid=$ZB;}}return$this->pid;}function isRunning(){if($this->pid>0){try{$F=shell_exec(sprintf('ps %d',$this->pid));return substr_count($F,"\n")>=2;}catch(\Exception$HB){}}return false;}function wait($CF=0.1){while($this->isRunning()){usleep($CF*1000000);}return true;}function stop(){if($this->pid>0&&$this->isRunning()){return posix_kill($this->pid,SIGTERM);}}function fork($mB=null,array$IC=array()){$qB=clone$this;$qB->args=array_merge($qB->args,$IC);$aB=strval($qB);$g=$qB->app;if($g->outfile!==1){$aB.=' > '.$g->getFileSymbol($g->outfile,true);}if($g->errfile!==2){$aB.=' 2 > '.$g->getFileSymbol($g->errfile,true);}if($ZB=shell_exec($aB.' & echo $!')){$ZB=trim($ZB);$qB->pid=intval($ZB);if(!is_null($mB)){file_put_contents($mB,$ZB.PHP_EOL,LOCK_EX);}}return$qB->pid;}function loop($q=1,$HC=0,$HD=0){if($HC>0){$HC=intval($HC)+time();}do{$this->execute();if($q>0){$q--;}if($HD>0){usleep($HD*1000000);}}while($q===0||$HC<0||$HC<time());}abstract function execute();}use \Cute\Application;use \Cute\Command;use \Cute\Utility\Inflect;class Console extends Application{const STDIN='php://stdin';const STDOUT='php://stdout';const STDERR='php://stderr';const DEVNULL='/dev/null';const COLOR_BLACK=90;const COLOR_RED=91;const COLOR_GREEN=92;const COLOR_YELLOW=93;const COLOR_BLUE=94;const COLOR_MAGENTA=95;const COLOR_CYAN=96;const COLOR_WHITE=97;protected$color=false;var$outfile=1;var$errfile=null;function initialize(){return$this;}static function getFileSymbol($l,$tC=false){if(is_null($l)){return self::DEVNULL;}else if(is_int($l)){if($l===0){return$tC?'&0':self::STDIN;}else if($l===1){return$tC?'&1':self::STDOUT;}else if($l===2){return$tC?'&2':self::STDERR;}}return strval($l);}static function appendTo($dB,$YB=false,$pB=null){if(empty($pB)&&$pB!==0){return 0;}if(is_int($pB)&&is_int($YB)){$dB=sprintf("\033[%dm%s\033[%dm",$YB,$dB,0);}$pB=self::getFileSymbol($pB);return file_put_contents($pB,$dB,FILE_APPEND|LOCK_EX);}function setColor($YB){if(is_string($YB)){$YB='COLOR_'.strtoupper($YB);$this->color=constant(__CLASS__.'::'.$YB);}return$this;}function write($dB){if(func_num_args()>1){$dB=exec_function_array('sprintf',func_get_args());}return self::appendTo($dB,$this->color,$this->outfile);}function writeln($dB){$A=func_get_args();$A[0].=PHP_EOL;return exec_method_array($this,'write',$A);}function mount($U){$ND=func_get_args();foreach($ND as&$U){$U=rtrim($U,DIRECTORY_SEPARATOR);}$kC=PATH_SEPARATOR.implode(PATH_SEPARATOR,$ND);set_include_path(get_include_path().$kC);return$this;}function run(){if(php_sapi_name()!=='cli'){return;}if($_SERVER['argc']<2){return;}$OB=$_SERVER['argv'];$xC=array_shift($OB);$D=array_shift($OB);$H=Inflect::camelize($D).'Command';@require_once$H.'.php';if(class_exists($H)){$k=new$H($this,$xC,$OB);return$k->execute();}}}class Factory{protected$storage=null;protected$objects=array();function __construct(Storage&$oB){$this->storage=$oB;}function normalize($H){return rtrim($H,'\\');}function create($H,$D='default'){$H=$this->normalize($H);$aC=$this->storage->getSectionOnce($H);$Q=$aC->getArray($D);if($D!=='default'){$Q=array_merge($aC->getArray('default'),$Q);}if(class_exists($H)){foreach($Q as$B=>&$C){if(starts_with($B,'\\')){$C=$this->load($B,$C);}}return exec_construct_array($H,array_values($Q));}}function load($H,$D='default'){$H=$this->normalize($H);if(!isset($this->objects[$H])){$this->objects[$H]=array();if(!isset($this->objects[$H][$D])){$this->objects[$H][$D]=$this->create($H,$D);}}return$this->objects[$H][$D];}}class Handler{protected$app=null;protected$succor=null;function __construct($jB=null){$this->app=app();$this->succor=$jB;}function init($V){return method_exists($this,$V)?$V:'';}function __invoke(){$V=$this->app->getMethod();$A=func_get_args();if($V=$this->init($V)){return exec_method_array($this,$V,$A);}else if($this->succor){return exec_function_array($this->succor,$A);}else{return$this->app->abort(403);}}}if(!function_exists('trait_exists')){function trait_exists($H,$QC){return false;}}final class Importer{private static$instance=null;private$classes=array();private$namespaces=array();private function __construct(){}static function getInstance(){if(is_null(self::$instance)){self::$instance=new self();self::$instance->register();}return self::$instance;}static function exists($H,$QC=true){return class_exists($H,$QC)||interface_exists($H,$QC)||trait_exists($H,$QC);}function autoload($H){$H=trim($H,'\\_');if(isset($this->classes[$H])){require_once$this->classes[$H];return self::exists($H,false);}$xE=$this->checkNamespace($H);return($xE===true);}function register(){return spl_autoload_register(array($this,'autoload'));}function addClass($S,$H){$eD=func_get_args();$S=array_shift($eD);if(is_readable($S)){foreach($eD as$H){$this->classes[trim($H,'\\')]=$S;}}ksort($this->classes);return$this;}function addNamespaceStrip($o,$N){$o=trim($o,'\\');$N=rtrim($N,'\\/');$this->namespaces[$o]=$N;ksort($this->namespaces);return$this;}function addNamespace($o,$N){$o=trim($o,'\\');$MB=strtok($o,'\\_');$N=rtrim($N,'\\/').DIRECTORY_SEPARATOR.$MB;return$this->addNamespaceStrip($o,$N);}function checkNamespace($H){$MB=strtok($H,'\\_');$Z=strlen($MB)+1;if(isset($this->namespaces[$MB])){$U=$this->namespaces[$MB];}else if(isset($this->namespaces[''])){$U=$this->namespaces[''];}else{return false;}$v=$U.DIRECTORY_SEPARATOR;$v.=str_replace(array('\\','_'),DIRECTORY_SEPARATOR,substr($H,$Z));if(file_exists($v.'.php')){require_once$v.'.php';if(self::exists($H,false)){return true;}}while($MB){$U.=DIRECTORY_SEPARATOR.$MB;if(file_exists($U.'.php')){require_once$U.'.php';if(self::exists($H,false)){return true;}}if(!file_exists($U)){return false;}$MB=strtok('\\_');}}}use \Cute\Context\Router;class Website extends Application{protected$method='';var$url='';var$rule='';function initialize(){$gB=Router::getCurrent();$this->install($gB,array('dispatch','abort','redirect'));$this->install('\\Cute\\Context\\Input',array('getClientIP','input'=>'getInstance',));return$this;}function route($U,$PB){$gB=Router::getCurrent();return$gB->route($U,$PB);}function mount($p,$EC='*.php'){$gB=Router::getCurrent();$gB->mount($p,$EC);return$this;}function getMethod(){if(empty($this->method)){$XB=$this->input('SERVER');$V=$XB->request('_method','');if(empty($V)){$V=$XB->get('REQUEST_METHOD','GET');}$this->method=strtolower($V);}return$this->method;}function run(){$kE=$this->getConfig('route_key','r');$U=$this->input('GET')->get($kE,'/');try{$WC=$this->dispatch($U);$jB=null;foreach($WC['handlers']as$PB){if(!is_callable($PB)){$PB=new$PB($jB);}$jB=&$PB;}if($jB){$this->url=$WC['url'];$this->rule=$WC['rule'];$OD=exec_function_array($jB,$WC['args']);}}catch(\Exception$HB){$OD=strval($HB);}return die($OD);}}}
namespace Cute\Base{trait Destructible{protected$GF=false;function defer(){register_shutdown_function(function($UE){$UE->__destruct();},$this);}function __destruct(){if($this->closed===false){$this->close();}$this->closed=true;}function close(){}}trait Imitation{protected$VC=null;private function __construct(&$VC=null){$this->inner=$VC;}static function mock(&$VC=null){$EB=new self($VC);return$EB->isReady()?$EB->inner:$EB;}function __call($D,$FD){return false;}function __set($D,$C){return false;}function __get($D){return;}function isReady(){return!is_null($this->inner);}}use \ArrayObject;class Storage extends ArrayObject{const CONFIG_SECTION_NAME='configs';function __construct($XB=array(),$VE=ArrayObject::ARRAY_AS_PROPS){parent::__construct($XB,$VE);}static function newInstance($S,$KD=false){$S.=empty($KD)?'':$KD;assert(is_readable($S));return new self(include$S);}function getItem($D,$L=null){$jD=$this->offsetGet($D);return is_null($jD)?$L:$jD;}function getArray($D,array$L=array()){$Q=$this->getItem($D);return is_array($Q)?$Q:$L;}function getSection($D){$Q=$this->getArray($D,array());return new self($Q);}function getSectionOnce($D){$Q=$this->getItem($D);if(!($Q instanceof self)){$Q=new self($Q);$this->offsetSet($D,$Q);}return$Q;}function getConfig($D,$L=null){$aC=$this->getSectionOnce(self::CONFIG_SECTION_NAME);return$aC->getItem($D,$L);}}}
namespace Cute\Context{class Input{protected static$instances=array();protected static$client_ip='-';protected$input_type=null;protected$data=array();protected$done=false;protected function __construct($BB='POST'){$this->input_type=constant('INPUT_'.$BB);if($BB==='REQUEST'){$this->raw_data=$_REQUEST;}assert(!is_null($this->input_type));}function __call($D,$FD){if(starts_with($D,'get')&&count($FD)>0){$E=substr($D,3);@list($B,$L)=$FD;return$this->get($B,$L,$E);}}static function getInstance($BB='POST'){$BB=strtoupper($BB);if(!isset(self::$instances[$BB])){$QB=new static($BB);self::$instances[$BB]=$QB;}return self::$instances[$BB];}static function request($B,$L=null,$E=false){$WE=self::getInstance('POST');$C=$WE->get($B,$L,$E);if($C===$L){$SE=self::getInstance('GET');$C=$SE->get($B,$L,$E);}return$C;}static function getClientIP(){if(strlen(self::$client_ip)>=7){return self::$client_ip;}$KC=array('HTTP_CLIENT_IP','HTTP_X_REAL_IP','HTTP_X_FORWARDED_FOR','HTTP_X_FORWARDED','HTTP_X_CLUSTER_CLIENT_IP','HTTP_FORWARDED_FOR','HTTP_FORWARDED','REMOTE_ADDR');$RE=self::getInstance('SERVER');foreach($KC as$B){$FC=$RE->get($B);if($FC&&strlen($FC)>=7){self::$client_ip=$FC;break;}}return self::$client_ip;}static function detectType($E){$E=empty($E)?'string':strtolower($E);foreach(filter_list()as$D){if(ends_with($D,$E)){return filter_id($D);}}}static function coerce($C,$E='raw'){if(is_array($C)){foreach($C as$B=>$GC){if(is_array($E)&&isset($E[$B])){$iD=$E[$B];}else{$iD=$E;}$C[$B]=self::coerce($GC,$iD);}}else{$E=strtolower($E);if($E==='int'||$E==='float'){settype($C,$E);}else if($E==='array'){$C=(array)$C;}else if($E!=='raw'){settype($C,'string');}}return$C;}protected function filterData($B,$E){$E=self::detectType($E);return filter_input($this->input_type,$B,$E);}protected function filterArrayData($SB){if(is_array($SB)){foreach($SB as$B=>&$E){if(is_array($E)){$E['filter']=self::detectType($E['filter']);}else{$E=self::detectType($E);}}}else{$SB=self::detectType($SB);}return filter_input_array($this->input_type,$SB);}function get($B,$L=null,$E=false){if(!array_key_exists($B,$this->data)){if(is_array($L)){$E=array($B=>array('filter'=>$E,'flags'=>FILTER_FORCE_ARRAY));$Q=$this->filterArrayData($E);$this->data=array_merge($this->data,$Q);}else{$C=$this->filterData($B,$E);if(is_null($C)||$C===false){$C=self::coerce($L,$E);}$this->data[$B]=$C;}}return$this->data[$B];}function all($B=false,$SB=false){if($this->done===false){$this->data=$this->filterArrayData($SB);}if(is_null($this->data)){$this->data=array();}if($B===false){return$this->data;}else if(array_key_exists($B,$this->data)){return$this->data[$B];}}}use \Cute\Context\Input;class Locale{protected$language='';protected$locale_dir='';protected$timezone='Asia/Shanghai';function __construct($AD='',$FB=''){if(empty($AD)){$AD=APP_ROOT.'/protected/locales';}$this->locale_dir=$AD;$this->timezone=$FB;}function detectLanguage(){$XB=Input::getInstance('SERVER');$DB=strstr($XB->get('LANG',''),'.',true);if(empty($DB)){$QE=$XB->get('HTTP_ACCEPT_LANGUAGE','');preg_match_all('/([a-z]{2}\-?[A-Z]{0,2})/',$QE,$GB);foreach($GB[0]as$DB){$DB=str_replace('-','_',$DB);if(file_exists($this->locale_dir.'/'.$DB)){break;}}}return$DB;}function setLocale($DB,$BD='messages'){if($DB){$this->language=$DB;}else{$this->language=$this->detectLanguage();}putenv('LANG='.$this->language);setlocale(LC_ALL,$this->language);bindtextdomain($BD,$this->locale_dir);bind_textdomain_codeset($BD,'UTF-8');textdomain($BD);return$this->language;}function setTimezone($FB){if($FB){$this->timezone=$FB;}@date_default_timezone_set($this->timezone);return$this->timezone;}}class Router{protected static$current=null;static$aliases=array('<int>'=>'([0-9\-]+)','<float>'=>'([0-9\.\-]+)','<num>'=>'([0-9\.\-,]*)','<string>'=>'([a-z0-9\-_]+)','<page>'=>'([0-9]*)/?([0-9]*)/?','<path>'=>'([a-z0-9\-_/])');protected$filename='';protected$prefix='';protected$children=array();protected$items=array();function __construct($S='',$i='/'){$this->filename=$S;$this->prefix=rtrim($i,'/');self::$current=$this;if($S&&is_readable($S)){include_once$S;}}static function getCurrent(){if(is_null(self::$current)){self::$current=new self();}return self::$current;}static function toPrefix($S){$XE=strstr(basename($S),'.');$hE=substr($S,0,-strlen($XE));$i=str_replace(DIRECTORY_SEPARATOR,'/',$hE);return strtolower(rtrim($i,'/'));}static function compileUrl($CB,$iE=false){$CB=preg_quote(strtolower(rtrim($CB,'/')));$KC=array_map('preg_quote',array_keys(self::$aliases));$P=array_values(self::$aliases);$CB=str_replace($KC,$P,$CB);$EC=($iE===false)?'':'(.*)?';return'!^'.$CB.'/?'.$EC.'$!';}function route($U,&$PB){$LC=self::compileUrl($U);if(func_num_args()>2){$dC=array_slice(func_get_args(),1);}else{$dC=array($PB);}$this->items[$LC]=$dC;return$LC;}function mount($p,$EC='*.php'){$p=rtrim($p,DIRECTORY_SEPARATOR);$eC=glob($p.'/'.$EC,GLOB_BRACE);if(!empty($eC)){$eE=strlen($p);foreach($eC as$S){$i=self::toPrefix(substr($S,$eE));$this->children[$i]=$S;}}return$this;}function dispatch($U,$SD=false){$U=rtrim(strtolower($U),' /').'/';if(!$SD){krsort($this->children);}foreach($this->children as$i=>$S){if(starts_with($U,$i)){$gB=new self($S,$i);$U=substr($U,strlen($i));return$gB->dispatch($U);}}if(!$SD){krsort($this->items);}foreach($this->items as$LC=>$dC){if(preg_match($LC,$U,$A)===1){$CB=$this->prefix.array_shift($A);return array('handlers'=>&$dC,'args'=>$A,'url'=>$CB,'rule'=>$LC);}}$this->abort(404);return array('handlers'=>array());}function abort($ZE=500){return@http_response_code($ZE);}function redirect($aE='',$bE=false){$cE=$bE?301:302;@header('Location: '.$aE,true,$cE);return die();}}class Session{}}
namespace Cute\DB{use \DateTime;use \PDO;use \PDOException;use \Cute\DB\Literal;class Database{const TYPE_UNSUPPORT=0;const TYPE_TOP=1;const TYPE_LIMIT=2;protected$pdo=null;protected$dbname='';protected$prefix='';function __construct(PDO&$FF,$KB='',$i=''){$this->pdo=$FF;if($KB){$this->useDB($KB,$i);}}function useDB($KB,$i='',$cC=false){assert(!is_null($this->pdo));if($cC&&$this->getDriverName()==='mysql'){$this->pdo->exec("CREATE DATABASE IF NOT EXIST `$KB`");}$this->pdo->exec("USE `$KB`");$this->dbname=$KB;$this->prefix=empty($i)?'':$i;return$this;}function getPDO(){return$this->pdo;}function getDriverName(){assert(!is_null($this->pdo));$iB=$this->pdo->getAttribute(PDO::ATTR_DRIVER_NAME);$iB=strtolower($iB);return$iB==='dblib'?'sqlsrv':$iB;}function getDBName(){return$this->dbname;}function getTableName($O,$TC=false){$Y=$this->prefix.$O;$gD=$this->getDriverName();if($gD==='mysql'){$G="SHOW Variables LIKE 'lower_case_table_names'";$dE=$this->fetch($G,array(),'Value');if(intval($dE)===1){$Y=strtolower($Y);}}if($TC===false){return$Y;}switch($gD){case'mysql':$Y="`$Y`";break;case'sqlite':case'sqlsrv':$Y="[$Y]";break;}return$Y;}function inline($r){return new Literal($r);}function quote($r){if(is_null($this->pdo)||is_null($r)||$r instanceof Literal||$r instanceof DateTime){return Literal::quote($r);}else{$E=is_int($r)?PDO::PARAM_INT:PDO::PARAM_STR;return$this->pdo->quote($r,$E);}}function embed($G,array$K=array()){foreach($K as&$r){$r=$this->quote($r);}$G=str_replace('?','%s',$G);return vsprintf($G,$K);}function execute($G,array$K=array()){assert(!is_null($this->pdo));if(!empty($K)){$G=$this->embed($G,$K);}try{$F=$this->pdo->exec($G);}catch(PDOException$HB){$T="SQL: $G\n".$HB->getMessage();throw new PDOException($T);}return$F;}function query($G,array$K=array()){assert(!is_null($this->pdo));try{$R=$this->pdo->prepare($G);if($R->execute($K)){$R->setFetchMode(PDO::FETCH_ASSOC);}}catch(PDOException$HB){$G=$this->embed($G,$K);$T="SQL: $G\n".$HB->getMessage();throw new PDOException($T);}return$R;}function fetch($G,array$K=array(),$AC=false){if($R=$this->query($G,$K)){if(is_numeric($AC)){$F=$R->fetchColumn(intval($AC));}else{$F=$R->fetch();if($F&&$AC){$F=isset($F[$AC])?$F[$AC]:null;}}$R->closeCursor();return$F;}}function listTables(){if(empty($this->prefix)){$G=sprintf("SHOW TABLES FROM %s",$this->getDBName());}else{$a=$this->quote(str_replace('_','\_',$this->prefix).'%');$G=sprintf("SHOW TABLES LIKE %s",$a);}$F=array();if($R=$this->query($G)){$gE=strlen($this->prefix);while($O=$R->fetchColumn(0)){$F[]=substr($O,$gE);}$R->closeCursor();}return$F;}function transact(callable$fE){assert(!is_null($this->pdo));if($this->pdo->beginTransaction()){$A=func_get_args();array_unshift($A,$this);try{$fE($A);$this->pdo->commit();}catch(PDOException$HB){$this->pdo->rollBack();}}}function readFields($O){$iB=$this->getDriverName();$H='\\Cute\\DB\\'.ucfirst($iB).'Schema';$YE=new$H($this,$O);$J=$YE->getColumns();$s=array();$_=array();foreach($J as$I){if($I->isPrimaryKey()){$s[]=$I->name;}$L=$I->default;$bD=$I->getCategory();if($bD==='int'){$L=intval($L);}else if($bD==='float'){$L=floatval($L);}$_[$I->name]=$L;}return compact('table','pkeys','fields');}}use \HandlerSocketi;class HandlerSocket{const HS_PORT_R=9998;const HS_PORT_RW=9999;protected$handler=null;protected$query=null;protected$read_only=false;protected$dbname='';protected$table='';protected$fields=array();protected$index=null;function __construct($KB,$ED='127.0.0.1',$DC=0,$PE=false){$this->dbname=$KB;$this->read_only=$PE;if(empty($DC)){$DC=$this->read_only?self::HS_PORT_R:self::HS_PORT_RW;}$this->handler=new HandlerSocketi($ED,$DC);}function open($O,$_){if(is_string($_)){$_=explode(',',str_replace(' ','',$_));}$this->table=$O;$this->fields=$_;$this->query=null;return$this;}protected function prepare($hB=null){if(empty($this->query)||$this->index!==$hB){$this->index=$hB;$OE=empty($this->index)?array():array('index'=>$this->index);$this->query=$this->handler->open_index($this->dbname,$this->table,$this->fields,$OE);}return$this->query;}function insert(array$PC){$B=$this->index;$F=$this->prepare($B)->insert($PC);return$F!==false;}function delete($C){if(func_num_args()>1){$B=$C;$C=func_get_arg(1);}else{$B=null;}return$this->prepare($B)->remove($C);}function truncate($NC){$_B=array();$B=null;$NC=is_array($NC)?$NC:func_get_args();foreach($NC as$IB){$_B[]=array('remove',$IB);}$F=$this->prepare($B)->multi($_B);$NE=create_function('$a,$b','return $a && $b;');return array_reduce($F,$NE,true);}function update(array$_C,$B,$C){return$this->prepare($B)->update($C,$_C);}function get($C){if(func_num_args()>1){$B=$C;$C=func_get_arg(1);}else{$B=null;}$F=$this->prepare($B)->find($C);if(empty($F)){return($F===false)?false:null;}return array_combine($this->fields,$F[0]);}function all($B=null,$j='>=',$C=0,$WB=0,$cD=0){$IC=array();if($WB>0){$IC['limit']=$WB;}if($cD>0){$IC['offset']=$cD;}$C=array($j=>$C);$F=$this->prepare($B)->find($C,$IC);if($F===false){return false;}foreach($F as&$b){$b=array_combine($this->fields,$b);}return$F;}function in($B,$C){$_B=array();$P=array_slice(func_get_args(),1);if(count($P)===1&&is_array($P[0])){$P=$P[0];}foreach($P as$C){$_B[]=array('find',$C);}$F=$this->prepare($B)->multi($_B);if($F===false){return false;}$tB=exec_function_array('array_merge',$F);foreach($tB as&$b){$b=array_combine($this->fields,$b);}return$tB;}}class Literal{protected$value;function __construct($C){$this->value=$C;}function __toString(){return strval($this->value);}static function quote($C){$DD="'%s'";if(is_null($C)){$C='NULL';}else if($C instanceof self){$C=strval($C);}else if($C instanceof DateTime){$C=sprintf($DD,$C->format('Y-m-d H:i:s'));}else if(is_string($C)){$C=sprintf($DD,convert($C,'UTF-8'));}else{$C=sprintf($DD,strval($C));}return$C;}}use \Cute\DB\Database;class MssqlSchema{protected$db=null;protected$dbname='';protected$table='';function __construct(Database&$W,$O){$this->db=$W;$this->dbname=$W->getDBName();$this->table=$W->getTableName($O,false);}function getLimitType(){return DB::TYPE_TOP;}function getPKey(){$G="SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.%s WHERE TABLE_SCHEMA='dbo'"." AND TABLE_CATALOG=? AND TABLE_NAME=? ORDER BY ORDINAL_POSITION";$K=array($this->dbname,$this->table);$TB=$this->db->fetch(sprintf($G,'KEY_COLUMN_USAGE'),$K,0);if(empty($TB)){$TB=$this->db->fetch(sprintf($G,'COLUMNS'),$K,0);}return$TB;}function getColumns(){$J=array('COLUMN_NAME','COLUMN_DEFAULT','COLUMN_KEY','IS_NULLABLE','COLUMN_TYPE','DATA_TYPE','CHARACTER_MAXIMUM_LENGTH','NUMERIC_PRECISION','NUMERIC_SCALE','DATETIME_PRECISION',);$G="SELECT %s FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA='dbo'"." AND TABLE_CATALOG=? AND TABLE_NAME=? ORDER BY ORDINAL_POSITION";$G=sprintf($G,implode(', ',$J));$K=array($this->dbname,$this->table);if($R=$this->db->query($G,$K)){$GD=PDO::FETCH_CLASS|PDO::FETCH_PROPS_LATE;$F=$R->fetchAll($GD,'\\Cute\\ORM\\Column');$R->closeCursor();return$F;}}function isExists(){$G="SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA='dbo'"." AND TABLE_CATALOG=? AND TABLE_NAME=?";$K=array($this->dbname,$this->table);$O=$this->db->fetch($G,$K,0);return$this->db->getTableName($O,false)===$this->table;}function getCreateSQL($RB,$J=array(),$zC=false,$lC=false){$NB="";$sB="";$h="";$J=$this->getColumns();if($zC||$lC){foreach($J as$I){if($I->getCategory()==='char'){$E="[".$I->type."](".intval($I->length).")";}else if($I->type==='numeric'){$E="[numeric](".$I->precision.", ".$I->scale.")";}else{$E="[".$I->type."]";}if($I->isPrimaryKey()){$NB="    [$D] $E IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,";$sB="PRIMARY KEY NONCLUSTERED ( [$D] ASC )";}else{$TE=$I->isNullable()?"NULL":"NOT NULL DEFAULT ".$I->default;$h.="    [$D] $E $TE,\n";}}}else{foreach($J as$I){$L=trim($I->default,"()");if($I->getCategory()==='char'){$Z=intval($I->length);$E=($Z>255||$Z<0)?"text":"varchar($Z)";}else if($I->getCategory()==='int'){$cB=intval($I->precision);if($L===''){$L="0";}$E=$I->type."($cB)";}else if($I->getCategory()==='float'){$cB=intval($I->precision);$mC=intval($I->scale);if($L===''){$L="0.0";}$E=$I->type;if($I->type==='real'){$E='float';}else if($I->type==='money'){$E='numeric';}$E.="($cB,$mC)";}else if($I->getCategory()==='datetime'){$E='datetime';}else{$E=$I->type;}if($I->isPrimaryKey()){$NB="    [$D] $E IDENTITY(1,1) NOT FOR REPLICATION NOT NULL,";$sB="PRIMARY KEY NONCLUSTERED ( [$D] ASC )";}else if(starts_with($E,'date')||ends_with($E,'text')){$h.="    [$D] $E NULL,\n";}else if($I->isNullable()){$h.="    [$D] $E NULL,\n";}else{$h.="    [$D] $E NOT NULL DEFAULT '$L',\n";}}}$CC=<<<EOD
IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES
    WHERE TABLE_SCHEMA='dbo' AND TABLE_NAME='%s')
BEGIN
CREATE TABLE [dbo].[%s] (
%s
%s
    CONSTRAINT [PK_%s]
    %s
    WITH ( PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF,
        ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON )
    ON [PRIMARY]
) ON [PRIMARY]
END
EOD
;if(empty($NB)){$h=rtrim($h,",\n");}$G=sprintf($CC,$RB,$RB,$NB,$h,$RB,$sB);return$G;}function sqlToFile($G,$v,$XC="\t",$oC=PHP_EOL,$BC='"',$qC=null){@mkdir(dirname($v),0664,true);$wC=fopen($v,'wb');$fB=0;$hD=$this->db->query($G);while($b=$hD->fetch()){if(is_null($qC)){fputcsv($wC,$b,$XC,$BC);}else{fwrite($wC,self::csvline($b,$XC,$oC,$BC,$qC));}$fB++;}$hD->closeCursor();fclose($wC);return$fB;}}class MysqlSchema{protected$db=null;protected$dbname='';protected$table='';function __construct(Database&$W,$O){$this->db=$W;$this->dbname=$W->getDBName();$this->table=$W->getTableName($O,false);}function getLimitType(){return DB::TYPE_LIMIT;}function getPKey(){$G="SELECT COLUMN_NAME FROM information_schema.COLUMNS"." WHERE TABLE_SCHEMA=? AND TABLE_NAME=? AND COLUMN_KEY='PRI'";$K=array($this->dbname,$this->table);return$this->db->fetch($G,$K,0);}function getColumns(){$J=array('COLUMN_NAME','COLUMN_DEFAULT','COLUMN_KEY','IS_NULLABLE','COLUMN_TYPE','DATA_TYPE','CHARACTER_MAXIMUM_LENGTH','NUMERIC_PRECISION','NUMERIC_SCALE','DATETIME_PRECISION',);$G="SELECT %s FROM information_schema.COLUMNS"." WHERE TABLE_SCHEMA=? AND TABLE_NAME=? ORDER BY ORDINAL_POSITION";$G=sprintf($G,implode(', ',$J));$K=array($this->dbname,$this->table);if($R=$this->db->query($G,$K)){$GD=PDO::FETCH_CLASS|PDO::FETCH_PROPS_LATE;$F=$R->fetchAll($GD,'\\Cute\\ORM\\Column');$R->closeCursor();return$F;}}function isExists(){$G="SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES"." WHERE TABLE_NAME=? AND (TABLE_SCHEMA=? OR TABLE_CATALOG=?)";$K=array($this->table,$this->dbname,$this->dbname);$O=$this->db->fetch($G,$K,0);return$this->db->getTableName($O,false)===$this->table;}function getCreateSQL($RB,$zC=false,$lC=false){if($zC){$G="CREATE TABLE `%s` LIKE `%s`";return sprintf($G,$RB,$this->table);}else if($lC){$cC=sprintf("CREATE TABLE `%s`",$this->table);$G=$this->db->fetch("SHOW $cC",array(),'Create Table');$G=preg_replace('/(AUTO_INCREMENT=\d+)/','AUTO_INCREMENT=1',$G,1);$AF=sprintf("CREATE TABLE IF NOT EXISTS `%s`",$RB);return str_replace($cC,$AF,$G);}else{$NB="";$sB="";$h="";$J=$this->getColumns();foreach($J as$I){$D=$I->name;$L=trim($I->default,"()");if($I->getCategory()==='char'){$Z=intval($I->length);$E=($Z>255||$Z<0)?"text":"varchar($Z)";}else if($I->getCategory()==='int'){$cB=intval($I->precision);if($L===''){$L="0";}$E=$I->type."($cB)";}else if($I->getCategory()==='float'){$cB=intval($I->precision);$mC=intval($I->scale);if($L===''){$L="0.0";}$E=$I->type;if($I->type==='real'){$E='float';}else if($I->type==='money'){$E='numeric';}$E.="($cB,$mC)";}else if($I->getCategory()==='datetime'){$E='datetime';}else{$E=$I->type;}if($I->isPrimaryKey()){$NB="    `$D` int(10) unsigned NOT NULL AUTO_INCREMENT,";$sB="PRIMARY KEY (`$D`)";}else if(starts_with($E,'date')||ends_with($E,'text')){$h.="    `$D` $E NULL,\n";}else if($I->isNullable()){$h.="    `$D` $E NULL,\n";}else{$h.="    `$D` $E NOT NULL DEFAULT '$L',\n";}}$CC=<<<EOD
CREATE TABLE IF NOT EXISTS `%s` (
%s
%s
    %s
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=COMPACT
EOD
;if(empty($NB)){$h=rtrim($h,",\n");}$G=sprintf($CC,$RB,$NB,$h,$sB);return$G;}}function sqlToFile($G,$v,$XC="\t",$oC=PHP_EOL,$BC='"',$qC=null){@mkdir(dirname($v),0664,true);$SC="FIELDS TERMINATED BY '".addslashes($XC)."'";$SC.=" LINES TERMINATED BY '".addslashes($oC)."'";if($BC){$SC.=" OPTIONALLY ENCLOSED BY '".addslashes($BC)."'";}if($_E){$SC.=" FIELDS ESCAPED BY '".addslashes($_E)."'";}$zB=sys_get_temp_dir().DIRECTORY_SEPARATOR.basename($v);$zE="$G INTO OUTFILE '$zB' $SC";try{if(file_exists($zB)){unlink($zB);}$this->db->execute($zE);if(file_exists($zB)){rename($zB,$v);$fB=shell_exec('wc -l '.$v.' | cut -d" " -f1');$fB=trim($fB);return is_numeric($fB)?intval($fB):0;}}catch(\Exception$HB){}}}}
namespace Cute\Logging{use \Cute\Logging\Logger;use \Cute\Base\Destructible;defined('LOG_WRITE_FILE_FREQ')or define('LOG_WRITE_FILE_FREQ',0.2);class FileLogger extends Logger{protected$filename='';protected$records=array();function __construct($D='',$p=false,$OC=false){$this->filename=($D?$D.'_':'').'%s.log';if($p===false){$p=realpath('./logs');}if(is_dir($p)||mkdir($p,0777,true)){$this->filename=$p.DIRECTORY_SEPARATOR.$this->filename;}parent::__construct($OC);$this->defer();}function close(){$this->writeFiles();unset($this->records);}function writeFiles(){foreach($this->records as$yE=>&$dD){$l=sprintf($this->filename,$yE);$kC=implode('',$dD);$rB=file_put_contents($l,$kC,FILE_APPEND|LOCK_EX);if($rB!==false){$dD=array();}}}function append(){$BF=implode(' ',func_get_args());$sC=date('Ymd');if(!isset($this->records[$sC])){$this->records[$sC]=array();}array_push($this->records[$sC],$BF.PHP_EOL);}function rawlog($JB,$T,array$M=array()){$JB=strtoupper($JB);if($this->compareLevel($JB)){$f=self::format($T,$M);$FC=self::getClientIP();$DF=date('Y-m-d H:i:s');$this->append($DF,$FC,$JB,$f);}if(LOG_WRITE_FILE_FREQ>=1||LOG_WRITE_FILE_FREQ>=mt_rand(1,10000)/10000){$this->writeFiles();}}}use \Cute\Context\Input;abstract class Logger{const EMERGENCY='EMERGENCY';const ALERT='ALERT';const CRITICAL='CRITICAL';const ERROR='ERROR';const WARNING='WARNING';const NOTICE='NOTICE';const INFO='INFO';const DEBUG='DEBUG';protected$threshold=false;protected$threshold_value=null;function __construct($OC=false){if($OC===false){$this->threshold=self::DEBUG;}else{$this->threshold=strtoupper($OC);}}static function format($T,array$M=array()){$f=is_null($T)?'':(string)$T;if(!empty($M)){$fD=array();foreach($M as$B=>$GC){$fD['{'.$B.'}']=$GC;}$f=strtr($f,$fD);}return$f;}static function getClientIP(){return Input::getClientIP();}function compareLevel($JB){static$RC=array(self::EMERGENCY=>0,self::ALERT=>1,self::CRITICAL=>2,self::ERROR=>3,self::WARNING=>4,self::NOTICE=>5,self::INFO=>6,self::DEBUG=>7,);if(is_null($this->threshold_value)&&isset($RC[$this->threshold])){$this->threshold_value=$RC[$this->threshold];}if(isset($RC[$JB])){return$RC[$JB]<=$this->threshold_value;}}function emergency($T,array$M=array()){$this->rawlog(self::EMERGENCY,$T,$M);}function alert($T,array$M=array()){$this->rawlog(self::ALERT,$T,$M);}function critical($T,array$M=array()){$this->rawlog(self::CRITICAL,$T,$M);}function error($T,array$M=array()){$this->rawlog(self::ERROR,$T,$M);}function warning($T,array$M=array()){$this->rawlog(self::WARNING,$T,$M);}function notice($T,array$M=array()){$this->rawlog(self::NOTICE,$T,$M);}function info($T,array$M=array()){$this->rawlog(self::INFO,$T,$M);}function debug($T,array$M=array()){$this->rawlog(self::DEBUG,$T,$M);}abstract function rawlog($JB,$T,array$M=array());abstract function close();}}
namespace Cute\ORM{use \Cute\ORM\Model;class Column extends Model{protected static$_keys=array('COLUMN_NAME'=>'name','COLUMN_DEFAULT'=>'default','COLUMN_KEY'=>'index','IS_NULLABLE'=>'nullable','COLUMN_TYPE'=>'column','DATA_TYPE'=>'type','CHARACTER_MAXIMUM_LENGTH'=>'length','NUMERIC_PRECISION'=>'precision','NUMERIC_SCALE'=>'scale','DATETIME_PRECISION'=>'datetime',);var$name='';var$default=null;var$index=null;var$nullable='YES';var$column='';var$type='';var$length=null;var$precision=null;var$scale=null;var$datetime=null;static function getTable(){return'COLUMNS';}function __set($MD,$C){if(isset(self::$_keys[$MD])){$D=self::$_keys[$MD];$this->$D=$C;}}function isPrimaryKey(){return$this->index==='PRI';}function isNullable(){return$this->nullable==='YES';}function getCategory(){if(!is_null($this->datetime)){return'datetime';}else if(!is_null($this->precision)){return$this->scale>0?'float':'int';}else if(!is_null($this->length)){return'char';}else{return$this->type;}}}class Model{protected static$_fields=array();static function getTable(){return'';}static function getPKeys(){return array();}function getRelations(){return array();}function getFields(){$O=$this->getTable();if(!isset(self::$_fields[$O])){$_=get_object_vars($this);foreach($_ as$D=>$L){if(starts_with($D,'_')){unset($_[$D]);}}self::$_fields[$O]=&$_;}return self::$_fields[$O];}function getID($JC=0){if($s=$this->getPKeys()){$TB=$s[$JC];return$this->$TB;}}function setID($IB){if($s=$this->getPKeys()){foreach($s as$JC=>$TB){$this->$TB=func_get_arg($JC);}}return$this;}function isExists(){$IB=$this->getID();return$IB!==0&&!is_null($IB);}}use \PDO;use \Cute\DB\Database;use \Cute\View\Templater;use \Cute\Utility\Inflect;class Query{const COUNT_INSERT_BULK_MAX=500;protected$db=null;protected$table='';protected$model='';protected$fetch_style=0;protected$constrains=array();protected$parameters=array();var$additions=array();var$relations=array();function __construct(Database&$W,$eB='\\Cute\\ORM\\Model',$O=''){$this->db=$W;if(is_object($eB)){$this->model=get_class($eB);}else{$this->model=$eB;}$this->fetch_style=PDO::FETCH_CLASS;if(method_exists($this->model,'__set')||method_exists($this->model,'__construct')){$this->fetch_style=$this->fetch_style|PDO::FETCH_PROPS_LATE;}if(empty($O)||$this->model!=='\\Cute\\ORM\\Model'){$this->table=exec_method_array($this->model,'getTable');}else{$this->table=$O;}}static function generateModel(Database&$W,$O,$D='',$o='',$ME=false){$Q=$W->readFields($O);if(empty($D)){$D=$ME?Inflect::singularize($O):$O;$D=Inflect::camelize($D);}$N=APP_ROOT.'/models';if($o){$N.='/'.str_replace('\\','/',trim($o));}if(!file_exists($N)){mkdir($N,0777,true);}$S="$N/$D.php";$Q['name']=$D;$Q['ns']=$o;$Q['protecteds']=array('password','salt');$CC=new Templater(SRC_ROOT);ob_start();$CC->render('model_tpl.php',$Q);$f="<?php\n\n".trim(ob_get_clean());file_put_contents($S,$f);return$S;}function getDB(){return$this->db;}function getModel(){return$this->model;}function getTable($TC=null){if(is_null($TC)){return$this->table;}else{assert($W=$this->getDB());return$W->getTableName($this->table,$TC);}}function join($D){$EF=func_get_args();$eB=exec_construct_array($this->model);$LD=$eB->getRelations();foreach($EF as$D){if(isset($LD[$D])){$this->relations[$D]=&$LD[$D];}}return$this;}function contain($lB,array$P){$y=count($P);if($y===0){$j='IS NULL';}else if($y===1){$j='= ?';}else{$LB=implode(', ',array_fill(0,count($P),'?'));$j='IN ('.$LB.')';}$P=array_values($P);$this->constrains[]="$lB $j";$this->parameters=array_merge($this->parameters,$P);return$this;}function filter($kB,$C,$j='= ?'){$j=empty($j)?false:strtoupper($j);if(is_array($C)){if(substr_count($kB,'?')===count($C)){$this->constrains[]="$lB $j";$this->parameters=array_merge($this->parameters,$C);}else{$this->contain($kB,$C);}}else if(is_null($C)){if(trim($j)==='<>'){$this->constrains[]="$kB IS NOT NULL";}else{$this->constrains[]="$kB IS NULL";}}else{$this->constrains[]=($j===false)?$kB:"$kB $j";$this->parameters[]=$C;}return$this;}function where(array&$A=array()){$n=implode(' AND ',$this->constrains);$K=$this->parameters;if(count($A)>0){$n.=($n?' AND ':'').array_shift($A);$K=array_merge($K,$A);}$n=$n?'WHERE '.$n:'';return array($n,$K);}function select($J='*',array$A=array()){$Y=$this->getTable(true);list($n,$K)=$this->where($A);if(is_object($J)){$J=get_object_vars($J);}if(is_array($J)){array_walk($J,create_function('&$v,$k','if(!is_numeric($k))$v.=" as ".$k;'));$J=implode(', ',$J);}$J=trim($J);$G="SELECT $J FROM $Y $n";foreach($this->additions as$B=>$C){$G.=" $B $C";}return$this->getDB()->query(rtrim($G),$K);}function rows($B=false,$J='*'){$A=array_slice(func_get_args(),2);if($R=$this->select($J,$A)){$F=array();if($B===false||is_null($B)){$F=$R->fetchAll();}else{while($b=$R->fetch()){$F[$b[$B]]=$b;}}$R->closeCursor();return$F;}}function all($WB=-1,$J='*'){if($WB>=0){$this->additions['LIMIT']=intval($WB);}$A=array_slice(func_get_args(),2);if($R=$this->select($J,$A)){$F=$R->fetchAll($this->fetch_style,$this->getModel());$R->closeCursor();foreach($this->relations as$D=>&$wE){$wE->bind($this)->relative($D,$F);}}return$F;}function combine($lB,array&$F,$vE=false,$J='*'){if(empty($lB)||count($F)===0){return$F;}$this->contain($lB,array_keys($F));if($J==='*'){$J=sprintf('%s,%s.*',$lB,$this->getTable(false));}if($R=$this->select($J)){$oE=$vE?PDO::FETCH_UNIQUE:PDO::FETCH_GROUP;$nE=$this->fetch_style|$oE;$F=$R->fetchAll($nE,$this->getModel());$R->closeCursor();}return$F;}function get($IB,$B=false,$J='*'){if(empty($B)){$s=exec_method_array($this->getModel(),'getPKeys');if(empty($s)){return;}$B=reset($s);}$PD=$this->all(1,$J,"$B = ?",$IB);return count($PD)>0?reset($PD):null;}function delete(){$A=func_get_args();$Y=$this->getTable(true);list($n,$K)=$this->where($A);$G="DELETE FROM $Y $n";$W=$this->getDB();if(empty($n)&&$W->getDriverName()==='mysql'){$G="TRUNCATE $Y";}return$W->execute(rtrim($G),$K);}function update(array$_C,$bB=false){$A=array_slice(func_get_args(),2);$Y=$this->getTable(true);list($n,$K)=$this->where($A);$QD=array();$P=array();foreach($_C as$B=>$GC){$QD[]=$B.'=?';$P[]=$GC;}$gC=$bB?'UPDATE DELAYED':'UPDATE';$G="$gC $Y SET ".implode(', ',$QD)." $n";$K=array_merge($P,$K);return$this->getDB()->execute(rtrim($G),$K);}function getInsertSQL(array$J,$bB=false){$Y=$this->getTable(true);$gC=$bB?'INSERT DELAYED':'INSERT INTO';if($y=count($J)){$J=implode(',',$J);$LB=implode(', ',array_fill(0,$y,'?'));return array("$gC $Y ($J)",$LB);}else{return array("$gC $Y",'');}}function insert(array$PC,$bB=false){assert($W=$this->getDB());list($G,$LB)=$this->getInsertSQL(array_keys($PC),$bB);if(!empty($LB)){$G.=" VALUES ($LB)";$K=array_values($PC);if($W->execute($G,$K)){return$W->getPDO()->lastInsertId();}}}function insertBulk(array$tB,array$J=null,$bB=false){assert(count($tB)>0);$Y=$this->getTable(true);if(empty($J)){$J=array_keys(reset($tB));}list($G,$LB)=$this->getInsertSQL($J,$bB);$mE=array_chunk($tB,self::COUNT_INSERT_BULK_MAX);foreach($mE as$YD){$lE=array_fill(0,count($YD),"($LB)");$G.=" VALUES ".implode(', ',$lE);$pE=array_map('array_values',$YD);$K=exec_funcution_array('array_merge',$pE);$this->getDB()->execute($G,$K);}}}use \Cute\ORM\Query;class Relation{const TYPE_ONE_TO_ONE=1;const TYPE_BELONGS_TO=2;const TYPE_HAS_MANY=3;const TYPE_MANY_TO_MANY=4;protected$query=null;protected$type=1;protected$model='';protected$table='';protected$foreign_key='';protected$another_foreign_key='';protected$middle_table='';function __construct($E,$eB='\\Cute\\Model',$O='',$qE='',$uE='',$tE=''){$this->type=$E;$this->model=$eB;$this->table=$O;$this->foreign_key=$qE;$this->another_foreign_key=$uE;$this->middle_table=$tE;}function bind(Query&$yB){$this->query=$yB;return$this;}function relative($D,array&$F){if(empty($F)){return array();}switch($this->type){case self::TYPE_ONE_TO_ONE:case self::TYPE_BELONGS_TO:$Q=$this->belongsTo($D,$F);break;case self::TYPE_HAS_MANY:$Q=$this->hasMany($D,$F);break;case self::TYPE_MANY_TO_MANY:$Q=$this->manyToMany($D,$F);break;default:$Q=array();break;}return$Q;}function belongsTo($D,array&$F){assert($W=$this->query->getDB());if(empty($this->foreign_key)){$this->foreign_key=$D.'_id';}$hC=$this->foreign_key;$yB=new Query($W,$this->model,$this->table);$s=exec_method_array($this->model,'getPKeys');if(empty($s)){return array();}$P=array();foreach($F as&$k){$P[$k->$hC]=null;}$yB->combine(reset($s),$P,true);foreach($F as&$k){$B=$k->$hC;if(isset($P[$B])){$k->$D=&$P[$B];}else{$k->$D=null;}}return$P;}function hasMany($D,array&$F){assert($W=$this->query->getDB());if(empty($this->foreign_key)){$Y=$this->query->getTable();$this->foreign_key=Inflect::singularize($Y).'_id';}$hC=$this->foreign_key;$yB=new Query($W,$this->model,$this->table);$P=array();foreach($F as&$k){$P[$k->getID()]=null;}$yB->combine($hC,$P,false);foreach($F as&$k){$B=$k->getID();if(isset($P[$B])){$k->$D=&$P[$B];}else{$k->$D=array();}}return$P;}function manyToMany($D,array&$F){throw new\BadMethodCallException();}}}
namespace Cute\Utility{class Date extends\DateTime{protected$timestamp=0;function __construct($uC='now',$FB=null){if(is_null($FB)&&$L=constant('DEFAULT_TIMEZONE')){$FB=new\DateTimeZone($L);}if(is_numeric($uC)){parent::__construct('now',$FB);$this->setTimestamp($uC);}else{parent::__construct($uC,$FB);}}static function parseDurtion($z){if(empty($z)){return 0;}if(is_int($z)||is_float($z)){return$z;}if(is_string($z)){$RD=strtolower(substr($z,-1));if(is_numeric($RD)){return floatval($z);}$z=trim(substr($z,0,-1));$q=1;switch($RD){case'w':$q*=7;case'd':$q*=24;case'h':$q*=60;case'm':$q*=60;}return floatval($z)*$q;}}function thisMonthBegin(){return new self($this->format('Y-m-01'));}function thisMonthEnd(){return new self($this->format('Y-m-01').' +1 month -1 day');}function nextMonthBegin(){return new self($this->format('Y-m-01').' +1 month');}}class Inflect{protected static$plural=array('/(quiz)$/i'=>"$1zes",'/^(ox)$/i'=>"$1en",'/([m|l])ouse$/i'=>"$1ice",'/(matr|vert|ind)ix|ex$/i'=>"$1ices",'/(x|ch|ss|sh)$/i'=>"$1es",'/([^aeiouy]|qu)y$/i'=>"$1ies",'/(hive)$/i'=>"$1s",'/(?:([^f])fe|([lr])f)$/i'=>"$1$2ves",'/(shea|lea|loa|thie)f$/i'=>"$1ves",'/sis$/i'=>"ses",'/([ti])um$/i'=>"$1a",'/(tomat|potat|ech|her|vet)o$/i'=>"$1oes",'/(bu)s$/i'=>"$1ses",'/(alias)$/i'=>"$1es",'/(octop)us$/i'=>"$1i",'/(ax|test)is$/i'=>"$1es",'/(us)$/i'=>"$1es",'/s$/i'=>"s",'/$/'=>"s");protected static$singular=array('/(quiz)zes$/i'=>"$1",'/(matr)ices$/i'=>"$1ix",'/(vert|ind)ices$/i'=>"$1ex",'/^(ox)en$/i'=>"$1",'/(alias)es$/i'=>"$1",'/(octop|vir)i$/i'=>"$1us",'/(cris|ax|test)es$/i'=>"$1is",'/(shoe)s$/i'=>"$1",'/(o)es$/i'=>"$1",'/(bus)es$/i'=>"$1",'/([m|l])ice$/i'=>"$1ouse",'/(x|ch|ss|sh)es$/i'=>"$1",'/(m)ovies$/i'=>"$1ovie",'/(s)eries$/i'=>"$1eries",'/([^aeiouy]|qu)ies$/i'=>"$1y",'/([lr])ves$/i'=>"$1f",'/(tive)s$/i'=>"$1",'/(hive)s$/i'=>"$1",'/(li|wi|kni)ves$/i'=>"$1fe",'/(shea|loa|lea|thie)ves$/i'=>"$1f",'/(^analy)ses$/i'=>"$1sis",'/((a)naly|(b)a|(d)iagno|(p)arenthe|(p)rogno|(s)ynop|(t)he)ses$/i'=>"$1$2sis",'/([ti])a$/i'=>"$1um",'/(n)ews$/i'=>"$1ews",'/(h|bl)ouses$/i'=>"$1ouse",'/(corpse)s$/i'=>"$1",'/(us)es$/i'=>"$1",'/s$/i'=>"");protected static$irregular=array('move'=>'moves','foot'=>'feet','goose'=>'geese','sex'=>'sexes','child'=>'children','man'=>'men','tooth'=>'teeth','person'=>'people');protected static$uncountable=array('sheep','fish','deer','series','species','money','rice','information','equipment');protected static$abbreviations=array('AD','API','B2B','B2C','C2C','CEO','CFO','COO','CTO','DB','DSA','GEO','GPS','HTML','HTTP','ID','IO','IP','IQ','MD5','MTV','MV','MVC','NBA','OK','P2P','PC','PV','PDF','PHP','QQ','RMB','RSA','SOHO','SHA','TV','UI','URI','URL','USA','VIP','WC','WEB','WAP','WIFI','XML',);static function pluralize($X){if(in_array(strtolower($X),self::$uncountable))return$X;foreach(self::$irregular as$a=>$F){$a='/'.$a.'$/i';if(preg_match($a,$X))return preg_replace($a,$F,$X);}foreach(self::$plural as$a=>$F){if(preg_match($a,$X))return preg_replace($a,$F,$X);}return$X;}static function singularize($X){if(in_array(strtolower($X),self::$uncountable))return$X;foreach(self::$irregular as$F=>$a){$a='/'.$a.'$/i';if(preg_match($a,$X))return preg_replace($a,$F,$X);}foreach(self::$singular as$a=>$F){if(preg_match($a,$X))return preg_replace($a,$F,$X);}return$X;}static function pluralizeIf($y,$X){if($y==1)return"1 $X";else return$y." ".self::pluralize($X);}static function camelize($X,$sE=false){$wB=explode('_',$X);if($sE){$TD=count($wB)-1;$wB[$TD]=self::pluralize($wB[$TD]);}foreach($wB as&$e){$e=ucfirst($e);if(strlen($e)>1&&strlen($e)<=4){$UD=strtoupper($e);if(in_array($UD,self::$abbreviations)){$e=$UD;}}}return implode('',$wB);}static function flatten($X,$rE='_'){$a='/([A-Z][A-Z0-9]*(?=$|[A-Z][a-z0-9])|[A-Za-z][a-z0-9]+)/';preg_match_all($a,$X,$GB);return strtolower(implode($rE,$GB[0]));}}class Polling{protected$channels=array();function __construct(array$jE=array()){$this->channels=$jE;}function randRoll(){static$hB=0;if($hB===0){shuffle($this->channels);$hB=count($this->channels);}return$this->channels[--$hB];}function roundRobin(&$YC,$mD=1){if(count($this->channels)<2){return current($this->channels);}$bC=null;$WD=0;$vC=0;foreach($this->channels as$IB=>$b){$ZD=$b['weight']*$mD;$vC+=$ZD;$b['last_value']+=$ZD;if(empty($YC)&&$b['last_value']>=$WD){$bC=$IB;$WD=$b['last_value'];}}if(!empty($YC)){$this->channels[$YC]['last_value']-=$vC;return$this->channels[$YC];}else if(!is_null($bC)){$this->channels[$bC]['last_value']-=$vC;return$this->channels[$bC];}}}class Word{protected$content='';function __construct($f=''){$this->content=$f;}static function randHash($Z=6){$Z=$Z>32?32:$Z;$nD=md5(mt_rand().time());$uD=substr($nD,0,$Z);return$uD;}static function randString($Z=6,$GE=2,$uB=''){if(empty($uB)){$uB='abcdefghijkmnpqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ23456789';}srand((float)microtime()*1000000);$ID='';$jC=ceil($Z/$GE);while($Z>0){$uB=str_shuffle($uB);$ID.=substr($uB,0,$jC);$Z-=$jC;$jC=min($Z,$jC);}return$ID;}function hasNonASCII(){return preg_match('/[^\x20-\x7f]/',$this->content);}function fetchFirstURL(){if(preg_match('/^http[^\x23-\x76]/i',$this->content,$GB)){return$GB[1];}}function getNumbers($JE=true){$q=preg_match_all('/[\d.]+/',$this->content,$GB);if($q===0||$q===false){return false;}$JD=implode(current($GB));return$JE?intval($JD):$JD;}function ver2int(){$AE=$this->getNumbers(false);$pC=array_map('intval',explode('.',$AE));$pC=array_pad($pC,3,0);return intval(vsprintf('%d%02d%02d',$pC));}}}
namespace Cute\View{class Compiler{protected$env=null;protected$source_dir='';protected$compiled_dir='';function __construct(){\app()->import('Twig',VENDOR_ROOT.'/Twig/lib');$this->env=new\Twig_Environment();}function addFunction($D,$BE=null){$yD=new\Twig_SimpleFunction($D,$BE);return$this->env->addFunction($D,$yD);}function setSourceDir($vB){$this->source_dir=rtrim($vB,' /\\');if(!file_exists($this->source_dir)){@mkdir($this->source_dir,0777,true);}$KE=new\Twig_Loader_Filesystem(array($this->source_dir));$this->env->setLoader($KE);return$this;}function setCompiledDir($d){$d=rtrim($d,' /\\');if($this->compiled_dir!==$d){$this->compiled_dir=$d;}if(!file_exists($this->compiled_dir)){@mkdir($this->compiled_dir,0777,true);}return$this;}function isSourceRelational(){return true;}function compileFile($VB,$xB,array$M=array()){$f=$this->env->loadTemplate($VB)->render($M);file_put_contents($xB,$f,LOCK_EX);}function compileTpl($c,$VB='',array$M=array()){$c=ltrim(str_replace('\\','/',$c),'/');if(empty($VB)){$VB=$this->source_dir.'/'.$c;}$xB=$this->compiled_dir.'/'.$c;$d=dirname($xB);if(!is_dir($d)){mkdir($d,0777,true);}if($this->isSourceRelational()){$VB=substr($VB,strlen($this->source_dir)+1);}$this->compileFile($VB,$xB,$M);return$xB;}function compileAll($N=false,array$M=array()){if(is_null($N)||$N===false){$N=$this->source_dir;}else{$N=rtrim(str_replace('\\','/',$N),'/');}$y=0;$zD=scandir($N);foreach($zD as$nC){if($nC==='.'||$nC==='..'){continue;}$UC=$N.'/'.$nC;if(is_dir($UC)){$this->compileAll($UC);}else{$c=substr($UC,strlen($this->source_dir));$this->compileTpl($c,$UC,$M);$y++;}}return$y;}}use \Cute\View\Compiler;class Templater{var$compiler=null;var$globals=array();protected$source_dir='';protected$extend_files=array();protected$template_blocks=array();protected$current_block='';function __construct($vB,$d=false){$this->setSourceDir($vB);if($d){$this->setCompileDir($d);}}static function replaceWith($f,array$M=array()){if(!empty($M)){$f=strtr($f,$M);}return$f;}function setSourceDir($vB){$this->source_dir=rtrim($vB,' /\\');if(!file_exists($this->source_dir)){@mkdir($this->source_dir,0777,true);}}function setCompileDir($d){if(is_null($this->compiler)){$this->compiler=new Compiler();}$d=rtrim($d,' /\\');$this->compiler->setSourceDir($this->source_dir);$this->compiler->setCompiledDir($d);$this->setSourceDir($d);return$this;}function updateGlobals(array$oD){if(func_num_args()===1){$this->globals=array_merge($this->globals,$oD);}else{$A=func_get_args();array_unshift($A,$this->globals);$this->globals=exec_function_array('array_merge',$A);}return$this;}function updateFunctions(array$sD){$rD=$this->compiler;foreach($sD as$D=>$m){$rD->addFunction($D,$m);}}function prepareFile($c){if($this->compiler){return$this->compiler->compileTpl($c,'',$this->globals);}else{return$this->source_dir.'/'.$c;}}function render($c,array$M=array()){extract($this->globals);extract($M);include$this->prepareFile($c);if(!empty($this->extend_files)){$tD=array_pop($this->extend_files);foreach($this->extend_files as$l){include$this->prepareFile($l);}extract($this->template_blocks);include$this->prepareFile($tD);}}function extendTpl($c){array_push($this->extend_files,$c);}function includeTpl($c,array$M=array()){extract($this->globals);extract($M);ob_start();include$this->prepareFile($c);$HE=trim(ob_get_clean());echo$HE;}function blockStart($_D='content'){$this->current_block=$_D;ob_start();}function blockEnd(){$CE=trim(ob_get_clean());$this->template_blocks[$this->current_block]=$CE;}}}
namespace Cute\Widget{use \Cute\Utility\Word;class Captcha{const ENCRYPT_SALT='captcha_code_salt';const FILENAME_PREFIX='cc_';var$phrase_size=6;var$width=80;var$height=30;var$font=null;var$finger_print=null;protected$builder=null;protected$savedir='';protected$saveurl='';function __construct($t=''){\app()->import('Gregwar',VENDOR_ROOT);$this->builder=new\Gregwar\Captcha\CaptchaBuilder();if(!empty($t)){$this->phrase_size=strlen($t);$this->builder->setPhrase($t);}else{$this->refresh();}$this->savedir=APP_ROOT.'/public/assets/captcha';@mkdir($this->savedir,0755,true);$this->saveurl=app()->getAssetURL().'/captcha';}static function newInstance($xD=6,$kD=80,$pD=30,$qD=null,$vD=null){$QB=new self();$QB->phrase_size=$xD;$QB->width=$kD;$QB->height=$pD;$QB->font=$qD;$QB->finger_print=$vD;return$QB;}protected static function encrypt($t){return md5(strtolower($t).self::ENCRYPT_SALT);}static function clean($N,$CD=0.3,$WB=60){$wD=mt_rand(1,10000)/10000;if($CD<=0||$CD>=1||$wD<=$CD){$lD=time()-$WB;$eC=glob($N.'cc_*.jpg');foreach($eC as$l){if(fileatime($l)<$lD){unlink($l);}}}}function refresh(){$t=Word::randString($this->phrase_size);$this->builder->setPhrase($t);return$this;}function build(array$A=array()){$EE=array($this->width,$this->height,$this->font,$this->finger_print,);exec_method_array($this->builder,'build',$A+$EE);return$this->builder;}function show(){@session_start();$t=$this->builder->getPhrase();$_SESSION['phrase']=self::encrypt($t);@header('Content-Type: image/jpeg');$this->build(func_get_args());return$this->builder->output();}function save(){self::clean($this->savedir,0.3,60);$S=uniqid(self::FILENAME_PREFIX).'.jpg';$this->build(func_get_args());$this->builder->save($this->savedir.'/'.$S);$t=$this->builder->getPhrase();$CB=$this->saveurl.'/'.$S.'#'.self::encrypt($t);die($CB);}}use \Cute\Widget\RedisCounter;use \Cute\Widget\FileCounter;abstract class Counter{protected$name='';protected$value=0;protected$maxium=0;function __construct($D,$C=0,$ZC=0){$this->name=$D;$this->value=intval($C);$this->maxium=intval($ZC);}static function newInstance($D,$C=0,$ZC=0){$EB=new RedisCounter($D,$C,$ZC);if(!$EB->connect()){$EB=new FileCounter($D,$C,$ZC);$EB->connect();}$EB->readValue();return$EB;}function increase($DE=1){$this->value+=$DE;if($this->maxium>0){$this->value=$this->value%$this->maxium;}$this->writeValue();return$this->value;}abstract function connect();abstract function readValue();abstract function writeValue();abstract function remove();}use \Cute\Widget\Counter;class FileCounter extends Counter{protected$filename='';function connect($N=false){if(empty($N)&&$N!==''){$N=sys_get_temp_dir();}else{$N=rtrim(str_replace('\\','/',$N),'/');}$this->filename=$N.'/'.$this->name.'.txt';if(!is_readable($this->filename)){$UB=touch($this->filename);}else{$UB=true;}if(!$UB){$this->filename='';}return$UB;}function readValue(){$C=false;$rB=filesize($this->filename);if($rB>0){$C=file_get_contents($this->filename);}if($C!==false&&strlen(trim($C))>0){$this->value=intval($C);}else{$this->writeValue();}return$this->value;}function writeValue(){$rB=file_put_contents($this->filename,$this->value);return$rB&&$rB>0;}function remove(){if(file_exists($this->filename)){return unlink($this->filename);}}}class RedisCounter extends Counter{protected$redis=null;function connect($ED='127.0.0.1',$DC=6379){if(!extension_loaded('redis')){return false;}$this->redis=new\Redis();try{$UB=$this->redis->connect($ED,$DC);}catch(Exception$HB){$UB=false;}if(!$UB){$this->redis=null;}return$UB;}function readValue(){$C=$this->redis->get($this->name);if($C!==false&&strlen(trim($C))>0){$this->value=intval($C);}else{$this->writeValue();}return$this->value;}function writeValue(){return$this->redis->set($this->name,$this->value);}function remove(){if($this->redis->exists($this->name)){$F=$this->redis->del($this->name);$this->redis->close();return$F;}}}}